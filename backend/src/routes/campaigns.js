// backend/src/routes/campaigns.js - „Ç≠„É£„É≥„Éö„Éº„É≥ÂâäÈô§Ê©üËÉΩËøΩÂä†Áâà
const dialerService = require('../services/dialerService');
const express = require('express');
const router = express.Router();
const db = require('../services/database');
const logger = require('../services/logger');

// „Ç≠„É£„É≥„Éö„Éº„É≥‰∏ÄË¶ßÂèñÂæó
router.get('/', async (req, res) => {
  try {
    const { page = 1, limit = 50, status, search } = req.query;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥‰∏ÄË¶ßÂèñÂæó: Page=${page}, Limit=${limit}, Status=${status}`);
    
    let whereClause = 'WHERE 1=1';
    let queryParams = [];
    
    if (status) {
      whereClause += ' AND c.status = ?';
      queryParams.push(status);
    }
    
    if (search) {
      whereClause += ' AND (c.name LIKE ? OR c.description LIKE ?)';
      const searchTerm = `%${search}%`;
      queryParams.push(searchTerm, searchTerm);
    }
    
    const offset = (parseInt(page) - 1) * parseInt(limit);
    
    const dataQuery = `
      SELECT c.id, c.name, c.description, c.status, c.created_at, c.updated_at, c.progress,
             ci.number as caller_id_number,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count
      FROM campaigns c
      LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id
      ${whereClause}
      ORDER BY c.created_at DESC
      LIMIT ${parseInt(limit)} OFFSET ${offset}
    `;
    
    const countQuery = `
      SELECT COUNT(*) as total
      FROM campaigns c
      ${whereClause}
    `;
    
    const [campaigns] = await db.query(dataQuery, queryParams);
    const [countResult] = await db.query(countQuery, queryParams);
    
    const total = countResult[0].total;
    const totalPages = Math.ceil(total / parseInt(limit));
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥ÂèñÂæóÁµêÊûú: ${campaigns.length}/${total}‰ª∂`);
    
    res.json({
      campaigns: campaigns || [],
      total: total,
      page: parseInt(page),
      limit: parseInt(limit),
      totalPages: totalPages
    });
    
  } catch (error) {
    logger.error('„Ç≠„É£„É≥„Éö„Éº„É≥‰∏ÄË¶ßÂèñÂæó„Ç®„É©„Éº:', error);
    res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥Ë©≥Á¥∞ÂèñÂæó
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Ë©≥Á¥∞ÂèñÂæó: ID=${id}`);
    
    const [campaigns] = await db.query(`
      SELECT c.*, 
             ci.number as caller_id_number,
             ci.description as caller_id_description,
             ci.provider as caller_id_provider,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id AND status = 'pending') as pending_count,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id AND status = 'completed') as completed_count,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id AND status = 'failed') as failed_count,
             (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id AND status = 'dnc') as dnc_count
      FROM campaigns c
      LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id
      WHERE c.id = ?
    `, [id]);
    
    if (campaigns.length === 0) {
      logger.warn(`„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${id}`);
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Ë©≥Á¥∞ÂèñÂæó: ID=${id}`);
    res.json(campaigns[0]);
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥Ë©≥Á¥∞ÂèñÂæó„Ç®„É©„Éº: ID=${req.params.id}`, error);
    res.status(500).json({ message: '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// ‚úÖ „Ç≠„É£„É≥„Éö„Éº„É≥ÂâäÈô§ - Êñ∞Ë¶èËøΩÂä†
router.delete('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    logger.info(`üóëÔ∏è „Ç≠„É£„É≥„Éö„Éº„É≥ÂâäÈô§ÈñãÂßã: ID=${id}`);
    
    // 1. „Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    const [campaigns] = await db.query('SELECT id, name, status FROM campaigns WHERE id = ?', [id]);
    
    if (campaigns.length === 0) {
      logger.warn(`ÂâäÈô§ÂØæË±°„ÅÆ„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${id}`);
      return res.status(404).json({ 
        success: false,
        message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' 
      });
    }
    
    const campaign = campaigns[0];
    
    // 2. „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂâäÈô§Á¢∫Ë™ç
    if (campaign.status === 'active') {
      logger.warn(`„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂâäÈô§Ë©¶Ë°å: ID=${id}`);
      return res.status(400).json({ 
        success: false,
        message: '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç≠„É£„É≥„Éö„Éº„É≥„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂÖà„Å´ÂÅúÊ≠¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' 
      });
    }
    
    // 3. Èñ¢ÈÄ£„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
    const [contactCount] = await db.query(
      'SELECT COUNT(*) as total FROM contacts WHERE campaign_id = ?', 
      [id]
    );
    
    const [callLogCount] = await db.query(
      'SELECT COUNT(*) as total FROM call_logs WHERE campaign_id = ?', 
      [id]
    );
    
    const contactTotal = contactCount[0].total;
    const callLogTotal = callLogCount[0].total;
    
    logger.info(`ÂâäÈô§ÂØæË±°„Éá„Éº„Çø: Campaign=${campaign.name}, Contacts=${contactTotal}, CallLogs=${callLogTotal}`);
    
    // 4. „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÈñãÂßã„Åó„Å¶ÂâäÈô§ÂÆüË°å
    await db.query('START TRANSACTION');
    
    try {
      // Èñ¢ÈÄ£„Éá„Éº„Çø„ÇíÈ†ÜÁï™„Å´ÂâäÈô§
      
      // 4-1. „Ç≠„É£„É≥„Éö„Éº„É≥Èü≥Â£∞„ÅÆÈñ¢ÈÄ£‰ªò„Åë„ÇíÂâäÈô§
      if (contactTotal > 0) {
        await db.query('DELETE FROM campaign_audio WHERE campaign_id = ?', [id]);
        logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Èü≥Â£∞Èñ¢ÈÄ£‰ªò„Åë„ÇíÂâäÈô§: ${id}`);
      }
      
      // 4-2. IVRË®≠ÂÆö„ÇíÂâäÈô§
      await db.query('DELETE FROM campaign_ivr_config WHERE campaign_id = ?', [id]);
      logger.info(`IVRË®≠ÂÆö„ÇíÂâäÈô§: ${id}`);
      
      // 4-3. ÈÄöË©±„É≠„Ç∞„ÇíÂâäÈô§
      if (callLogTotal > 0) {
        const [callLogResult] = await db.query('DELETE FROM call_logs WHERE campaign_id = ?', [id]);
        logger.info(`ÈÄöË©±„É≠„Ç∞„ÇíÂâäÈô§: ${callLogResult.affectedRows}‰ª∂`);
      }
      
      // 4-4. ÈÄ£Áµ°ÂÖà„ÇíÂâäÈô§
      if (contactTotal > 0) {
        const [contactResult] = await db.query('DELETE FROM contacts WHERE campaign_id = ?', [id]);
        logger.info(`ÈÄ£Áµ°ÂÖà„ÇíÂâäÈô§: ${contactResult.affectedRows}‰ª∂`);
      }
      
      // 4-5. „Ç≠„É£„É≥„Éö„Éº„É≥Êú¨‰Ωì„ÇíÂâäÈô§
      const [campaignResult] = await db.query('DELETE FROM campaigns WHERE id = ?', [id]);
      
      if (campaignResult.affectedRows === 0) {
        throw new Error('„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
      
      // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥Á¢∫ÂÆö
      await db.query('COMMIT');
      
      logger.info(`‚úÖ „Ç≠„É£„É≥„Éö„Éº„É≥ÂâäÈô§ÂÆå‰∫Ü: ID=${id}, Name=${campaign.name}`);
      
      res.json({
        success: true,
        message: `„Ç≠„É£„É≥„Éö„Éº„É≥„Äå${campaign.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`,
        deletedCampaign: {
          id: parseInt(id),
          name: campaign.name
        },
        deletedData: {
          contacts: contactTotal,
          callLogs: callLogTotal
        }
      });
      
    } catch (deleteError) {
      // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„É≠„Éº„É´„Éê„ÉÉ„ÇØ
      await db.query('ROLLBACK');
      throw deleteError;
    }
    
  } catch (error) {
    logger.error(`üî• „Ç≠„É£„É≥„Éö„Éº„É≥ÂâäÈô§„Ç®„É©„Éº: ID=${req.params.id}`, error);
    
    let errorMessage = '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
    let statusCode = 500;
    
    if (error.message.includes('foreign key constraint')) {
      errorMessage = 'Èñ¢ÈÄ£„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì';
      statusCode = 400;
    }
    
    res.status(statusCode).json({ 
      success: false,
      message: errorMessage,
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥‰ΩúÊàê
router.post('/', async (req, res) => {
  try {
    const { name, description, caller_id_id, script } = req.body;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥‰ΩúÊàê: Name=${name}`);
    
    if (!name) {
      return res.status(400).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥Âêç„ÅØÂøÖÈ†à„Åß„Åô' });
    }
    
    const [result] = await db.query(
      'INSERT INTO campaigns (name, description, caller_id_id, script, status, created_at) VALUES (?, ?, ?, ?, ?, NOW())',
      [name, description || '', caller_id_id || null, script || '', 'draft']
    );
    
    const campaignId = result.insertId;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥‰ΩúÊàêÂÆå‰∫Ü: ID=${campaignId}, Name=${name}`);
    
    res.status(201).json({
      success: true,
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü',
      campaign: {
        id: campaignId,
        name: name,
        description: description || '',
        status: 'draft'
      }
    });
    
  } catch (error) {
    logger.error('„Ç≠„É£„É≥„Éö„Éº„É≥‰ΩúÊàê„Ç®„É©„Éº:', error);
    res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥Êõ¥Êñ∞
router.put('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { name, description, caller_id_id, script, status } = req.body;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Êõ¥Êñ∞: ID=${id}`);
    
    const [campaigns] = await db.query('SELECT id FROM campaigns WHERE id = ?', [id]);
    
    if (campaigns.length === 0) {
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    const [result] = await db.query(
      'UPDATE campaigns SET name = ?, description = ?, caller_id_id = ?, script = ?, status = ?, updated_at = NOW() WHERE id = ?',
      [name, description || '', caller_id_id || null, script || '', status || 'draft', id]
    );
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Êõ¥Êñ∞ÂÆå‰∫Ü: ID=${id}`);
    
    res.json({
      success: true,
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü',
      campaignId: parseInt(id)
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥Êõ¥Êñ∞„Ç®„É©„Éº: ID=${req.params.id}`, error);
    res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã
router.post('/:id/start', async (req, res) => {
  try {
    const { id } = req.params;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã: ID=${id}`);
    
    const [result] = await db.query(
      'UPDATE campaigns SET status = "active", updated_at = NOW() WHERE id = ? AND status != "active"',
      [id]
    );
    
    if (result.affectedRows === 0) {
      return res.status(400).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„ÅãÊó¢„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„Åô' });
    }
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßãÂÆå‰∫Ü: ID=${id}`);
    
    res.json({
      success: true,
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü',
      campaignId: parseInt(id)
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã„Ç®„É©„Éº: ID=${req.params.id}`, error);
    res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢
router.post('/:id/stop', async (req, res) => {
  try {
    const { id } = req.params;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢: ID=${id}`);
    
    const [result] = await db.query(
      'UPDATE campaigns SET status = "paused", updated_at = NOW() WHERE id = ? AND status = "active"',
      [id]
    );
    
    if (result.affectedRows === 0) {
      return res.status(400).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åã„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì' });
    }
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢ÂÆå‰∫Ü: ID=${id}`);
    
    res.json({
      success: true,
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü',
      campaignId: parseInt(id)
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢„Ç®„É©„Éº: ID=${req.params.id}`, error);
    res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// „Ç≠„É£„É≥„Éö„Éº„É≥Áµ±Ë®àÂèñÂæó
router.get('/:id/stats', async (req, res) => {
  try {
    const { id } = req.params;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Áµ±Ë®àÂèñÂæó: ID=${id}`);
    
    // „Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    const [campaigns] = await db.query('SELECT * FROM campaigns WHERE id = ?', [id]);
    
    if (campaigns.length === 0) {
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    // ÈÄ£Áµ°ÂÖàÁµ±Ë®à
    const [contactStats] = await db.query(`
      SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
        SUM(CASE WHEN status = 'called' THEN 1 ELSE 0 END) as called,
        SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
        SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
        SUM(CASE WHEN status = 'dnc' THEN 1 ELSE 0 END) as dnc
      FROM contacts 
      WHERE campaign_id = ?
    `, [id]);
    
    // ÈÄöË©±Áµ±Ë®à
    const [callStats] = await db.query(`
      SELECT 
        COUNT(*) as total_calls,
        SUM(CASE WHEN status = 'ANSWERED' THEN 1 ELSE 0 END) as answered_calls,
        SUM(CASE WHEN status = 'NO ANSWER' THEN 1 ELSE 0 END) as no_answer_calls,
        SUM(CASE WHEN status = 'BUSY' THEN 1 ELSE 0 END) as busy_calls,
        SUM(CASE WHEN status = 'FAILED' THEN 1 ELSE 0 END) as failed_calls,
        AVG(duration) as avg_duration
      FROM call_logs 
      WHERE campaign_id = ?
    `, [id]);
    
    const contactStat = contactStats[0];
    const callStat = callStats[0];
    
    // ÈÄ≤ÊçóÁéá„ÇíË®àÁÆó
    // ÈÄ≤ÊçóÁéá„ÇíË®àÁÆóÔºà‰øÆÊ≠£ÁâàÔºâ
   const totalContacts = contactStat.total || 0;
   const processedContacts = (contactStat.completed || 0) + (contactStat.failed || 0) + (contactStat.dnc || 0);

   let progress = 0;
   if (totalContacts > 0) {
    progress = Math.round((processedContacts / totalContacts) * 100);
    progress = Math.min(Math.max(progress, 0), 100); // 0-100%„Å´Âà∂Èôê
   }

   console.log(`ÈÄ≤ÊçóË®àÁÆó„Éá„Éê„ÉÉ„Ç∞: total=${totalContacts}, processed=${processedContacts}, progress=${progress}%`);
    // ÊàêÂäüÁéá„ÇíË®àÁÆó
    const successRate = callStat.total_calls > 0 
      ? Math.round((callStat.answered_calls / callStat.total_calls) * 100) 
      : 0;
    
    logger.info(`„Ç≠„É£„É≥„Éö„Éº„É≥Áµ±Ë®àÂèñÂæóÂÆå‰∫Ü: ID=${id}, Progress=${progress}%`);
    
    res.json({
      campaignId: parseInt(id),
      campaignName: campaigns[0].name,
      campaignStatus: campaigns[0].status,
      progress,
      successRate,
      contacts: {
        total: contactStat.total,
        pending: contactStat.pending,
        called: contactStat.called,
        completed: contactStat.completed,
        failed: contactStat.failed,
        dnc: contactStat.dnc
      },
      calls: {
        total: callStat.total_calls || 0,
        answered: callStat.answered_calls || 0,
        noAnswer: callStat.no_answer_calls || 0,
        busy: callStat.busy_calls || 0,
        failed: callStat.failed_calls || 0,
        avgDuration: callStat.avg_duration ? Math.round(callStat.avg_duration) : 0
      }
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥Áµ±Ë®àÂèñÂæó„Ç®„É©„Éº: ID=${req.params.id}`, error);
    res.status(500).json({ message: '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// üöÄ „Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßãAPIÔºàÊó¢Â≠ò„Ç≥„Éº„Éâ„ÅÆÂæå„Å´ËøΩÂä†Ôºâ
router.post('/:id/start', async (req, res) => {
  try {
    const campaignId = parseInt(req.params.id);
    
    logger.info(`üöÄ „Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã„É™„ÇØ„Ç®„Çπ„Éà: ${campaignId}`);
    
    // „Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂ≠òÂú®„Å®Áä∂ÊÖãÁ¢∫Ë™ç
    const [campaigns] = await db.query(
      'SELECT * FROM campaigns WHERE id = ?',
      [campaignId]
    );
    
    if (campaigns.length === 0) {
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    const campaign = campaigns[0];
    
    if (campaign.status === 'active') {
      return res.status(400).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅØÊó¢„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„Åô' });
    }
    
    // Áô∫‰ø°ÂØæË±°„ÅÆÈÄ£Áµ°ÂÖàÊï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    const [contactCount] = await db.query(
      'SELECT COUNT(*) as count FROM contacts WHERE campaign_id = ? AND status = "pending"',
      [campaignId]
    );
    
    if (contactCount[0].count === 0) {
      return res.status(400).json({ 
        message: 'Áô∫‰ø°ÂØæË±°„ÅÆÈÄ£Áµ°ÂÖà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÈÄ£Áµ°ÂÖà„ÇíËøΩÂä†„Åó„Å¶„Åã„Çâ„Ç≠„É£„É≥„Éö„Éº„É≥„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' 
      });
    }
    
    // dialerService„Åß„Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã
    const result = await dialerService.startCampaign(campaignId);
    
    if (!result) {
      return res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
    }
    
    logger.info(`‚úÖ „Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßãÊàêÂäü: ${campaignId}`);
    
    res.json({
      success: true,
      message: `„Ç≠„É£„É≥„Éö„Éº„É≥„Äå${campaign.name}„Äç„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`,
      campaign: {
        id: campaignId,
        name: campaign.name,
        totalContacts: contactCount[0].count
      }
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥ÈñãÂßã„Ç®„É©„Éº: ${req.params.id}`, error);
    res.status(500).json({ 
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
      error: error.message 
    });
  }
});

// 4. „Ç≠„É£„É≥„Éö„Éº„É≥Ë®≠ÂÆöÁîªÈù¢Áî®„ÅÆËª¢ÈÄÅË®≠ÂÆöÂèñÂæóAPI
// backend/src/routes/campaigns.js „Å´ËøΩÂä†

router.get('/:id/transfer-settings', async (req, res) => {
  try {
    const { id } = req.params;
    
    const [campaign] = await db.query(`
      SELECT 
        c.id,
        c.name,
        c.transfer_enabled,
        c.operator_number,
        c.transfer_message,
        ci.number as caller_id_number,
        ci.description as caller_id_description
      FROM campaigns c
      LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id  
      WHERE c.id = ?
    `, [id]);
    
    if (campaign.length === 0) {
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
    const transferSettings = {
      transferEnabled: campaign[0].transfer_enabled || true,
      operatorNumber: campaign[0].operator_number || campaign[0].caller_id_number,
      transferMessage: campaign[0].transfer_message || '„Ç™„Éö„É¨„Éº„Çø„Éº„Å´Ëª¢ÈÄÅ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇÂ∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ',
      callerIdNumber: campaign[0].caller_id_number,
      callerIdDescription: campaign[0].caller_id_description
    };
    
    res.json({
      success: true,
      campaignId: parseInt(id),
      transferSettings: transferSettings
    });
    
  } catch (error) {
    logger.error('Ëª¢ÈÄÅË®≠ÂÆöÂèñÂæó„Ç®„É©„Éº:', error);
    res.status(500).json({ message: 'Ëª¢ÈÄÅË®≠ÂÆö„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// 5. Ëª¢ÈÄÅË®≠ÂÆöÊõ¥Êñ∞API
router.put('/:id/transfer-settings', async (req, res) => {
  try {
    const { id } = req.params;
    const { transferEnabled, operatorNumber, transferMessage } = req.body;
    
    await db.query(`
      UPDATE campaigns 
      SET 
        transfer_enabled = ?,
        operator_number = ?,
        transfer_message = ?,
        updated_at = NOW()
      WHERE id = ?
    `, [transferEnabled, operatorNumber, transferMessage, id]);
    
    res.json({
      success: true,
      message: 'Ëª¢ÈÄÅË®≠ÂÆö„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü',
      campaignId: parseInt(id)
    });
    
  } catch (error) {
    logger.error('Ëª¢ÈÄÅË®≠ÂÆöÊõ¥Êñ∞„Ç®„É©„Éº:', error);
    res.status(500).json({ message: 'Ëª¢ÈÄÅË®≠ÂÆö„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// 6. ÁÆ°ÁêÜÁîªÈù¢Áî®„ÅÆËª¢ÈÄÅÁä∂Ê≥ÅÁõ£Ë¶ñAPIÔºà„É™„Ç¢„É´„Çø„Ç§„É†È¢®Ôºâ
router.get('/transfers/realtime', async (req, res) => {
  try {
    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ëª¢ÈÄÅ„ÅÆÁä∂Ê≥Å
    const activeTransfers = transferService.getAllTransferStatus();
    
    // ‰ªäÊó•„ÅÆËª¢ÈÄÅÁµ±Ë®à
    const [todayStats] = await db.query(`
      SELECT 
        COUNT(*) as total_transfers,
        SUM(CASE WHEN transfer_status = 'completed' THEN 1 ELSE 0 END) as completed_transfers,
        SUM(CASE WHEN transfer_status = 'failed' THEN 1 ELSE 0 END) as failed_transfers,
        AVG(operator_duration) as avg_operator_duration
      FROM transfer_logs 
      WHERE DATE(created_at) = CURDATE()
    `);
    
    res.json({
      success: true,
      timestamp: new Date().toISOString(),
      activeTransfers: activeTransfers,
      todayStats: todayStats[0] || {
        total_transfers: 0,
        completed_transfers: 0, 
        failed_transfers: 0,
        avg_operator_duration: 0
      }
    });
    
  } catch (error) {
    logger.error('„É™„Ç¢„É´„Çø„Ç§„É†Ëª¢ÈÄÅÁä∂Ê≥ÅÂèñÂæó„Ç®„É©„Éº:', error);
    res.status(500).json({ message: '„É™„Ç¢„É´„Çø„Ç§„É†Ëª¢ÈÄÅÁä∂Ê≥Å„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
  }
});

// üõë „Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢APIÔºà‰∏äË®ò„ÅÆÂæå„Å´ËøΩÂä†Ôºâ
router.post('/:id/stop', async (req, res) => {
  try {
    const campaignId = parseInt(req.params.id);
    
    logger.info(`üõë „Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢„É™„ÇØ„Ç®„Çπ„Éà: ${campaignId}`);
    
    // „Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂ≠òÂú®Á¢∫Ë™ç
    const [campaigns] = await db.query(
      'SELECT * FROM campaigns WHERE id = ?',
      [campaignId]
    );
    
    if (campaigns.length === 0) {
      return res.status(404).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' });
    }
    
    const campaign = campaigns[0];
    
    // dialerService„Åß„Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢
    const result = await dialerService.pauseCampaign(campaignId);
    
    if (!result) {
      return res.status(500).json({ message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' });
    }
    
    logger.info(`‚úÖ „Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢ÊàêÂäü: ${campaignId}`);
    
    res.json({
      success: true,
      message: `„Ç≠„É£„É≥„Éö„Éº„É≥„Äå${campaign.name}„Äç„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü`,
      campaign: {
        id: campaignId,
        name: campaign.name
      }
    });
    
  } catch (error) {
    logger.error(`„Ç≠„É£„É≥„Éö„Éº„É≥ÂÅúÊ≠¢„Ç®„É©„Éº: ${req.params.id}`, error);
    res.status(500).json({ 
      message: '„Ç≠„É£„É≥„Éö„Éº„É≥„ÅÆÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
      error: error.message 
    });
  }
});

module.exports = router;
