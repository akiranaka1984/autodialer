// backend/src/index.js - ãƒãƒ¼ãƒˆç«¶åˆå®Œå…¨è§£æ±ºç‰ˆ
const express = require('express');
const cors = require('cors');
const http = require('http');
const logger = require('./services/logger');
const db = require('./services/database');

require('dotenv').config();

const app = express();

// ğŸ”¥ å‹•çš„ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦æ©Ÿèƒ½
const findAvailablePort = async (startPort = 5000) => {
  const net = require('net');
  
  for (let port = startPort; port <= startPort + 10; port++) {
    try {
      await new Promise((resolve, reject) => {
        const server = net.createServer();
        
        server.listen(port, (err) => {
          if (err) {
            reject(err);
          } else {
            server.close(() => resolve());
          }
        });
        
        server.on('error', reject);
      });
      
      return port;
    } catch (error) {
      console.log(`ãƒãƒ¼ãƒˆ ${port} ã¯ä½¿ç”¨ä¸­: ${error.code}`);
      continue;
    }
  }
  
  throw new Error('åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
};

// ğŸ”§ å˜ä¸€ã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿è¨¼
let server = null;
let isServerStarted = false;

// CORSè¨­å®š
app.use((req, res, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, PATCH, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, Cache-Control, Pragma');
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Max-Age', '86400');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  next();
});

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
app.use((req, res, next) => {
  console.log(`${req.method} ${req.url} - Origin: ${req.headers.origin || 'none'}`);
  next();
});

// âœ… ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
console.log('ğŸš€ ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²é–‹å§‹...');

const routerStatus = {
  system: false,
  contacts: false,
  campaigns: false,
  callerIds: false,
  calls: false,
  audio: false,
  ivr: false
};

// ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²é–¢æ•°
const registerRouter = (path, routerFile, name) => {
  try {
    const router = require(routerFile);
    app.use(path, router);
    routerStatus[name] = true;
    console.log(`âœ… ${name} router ç™»éŒ²æˆåŠŸ`);
    return true;
  } catch (error) {
    console.error(`âŒ ${name} router ç™»éŒ²å¤±æ•—:`, error.message);
    return false;
  }
};

// å„ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
registerRouter('/api/system', './routes/system', 'system');
registerRouter('/api', './routes/contacts', 'contacts');
registerRouter('/api/campaigns', './routes/campaigns', 'campaigns');
registerRouter('/api/caller-ids', './routes/callerIds', 'callerIds');
registerRouter('/api/calls', './routes/calls', 'calls');
registerRouter('/api/audio', './routes/audio', 'audio');
registerRouter('/api/ivr', './routes/ivr', 'ivr');

console.log('ğŸ“Š ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²çŠ¶æ³:', routerStatus);

// èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post("/api/auth/login", (req, res) => {
  const { username, password } = req.body;
  console.log("ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:", username);
  if (username && password) {
    res.json({
      success: true,
      user: { username: username, role: "admin", name: "ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…" },
      token: "dummy-token-" + Date.now()
    });
  } else {
    res.status(400).json({ success: false, message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™" });
  }
});

app.get("/api/auth/profile", (req, res) => {
  res.json({
    id: 1,
    username: "admin",
    name: "ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…",
    role: "admin"
  });
});

// åŸºæœ¬ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get('/', (req, res) => {
  res.json({ 
    message: 'ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ APIç¨¼åƒä¸­ï¼ˆãƒãƒ¼ãƒˆç«¶åˆè§£æ±ºç‰ˆï¼‰',
    version: '1.4.2-fixed',
    timestamp: new Date().toISOString(),
    routerStatus: routerStatus,
    port: process.env.ACTIVE_PORT || 'dynamic'
  });
});

app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    server: 'main-fixed',
    routerStatus: routerStatus,
    port: process.env.ACTIVE_PORT
  });
});

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯APIï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç®¡ç†ï¼‰
if (!routerStatus.campaigns) {
  console.log('ğŸ”„ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™»éŒ²ä¸­...');
  
  app.get('/api/campaigns', async (req, res) => {
    try {
      const [campaigns] = await db.query(`
        SELECT c.id, c.name, c.description, c.status, c.created_at, c.updated_at, c.progress,
               ci.number as caller_id_number,
               (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count
        FROM campaigns c
        LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id
        ORDER BY c.created_at DESC
      `);
      
      res.json({
        campaigns: campaigns || [],
        total: campaigns ? campaigns.length : 0,
        page: 1,
        limit: 50,
        totalPages: 1
      });
    } catch (error) {
      console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ 
        campaigns: [], 
        total: 0, 
        message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' 
      });
    }
  });
  
  app.post('/api/campaigns/:id/start', async (req, res) => {
    try {
      const { id } = req.params;
      const [result] = await db.query(
        'UPDATE campaigns SET status = "active", updated_at = NOW() WHERE id = ?',
        [id]
      );
      
      if (result.affectedRows === 0) {
        return res.status(400).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
      }
      
      res.json({
        success: true,
        message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ',
        campaignId: parseInt(id)
      });
    } catch (error) {
      console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });
}

// ãƒ†ã‚¹ãƒˆç™ºä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
if (!routerStatus.calls) {
  app.post('/api/calls/test', async (req, res) => {
    try {
      const { phoneNumber, callerID, mockMode } = req.body;
      
      if (!phoneNumber) {
        return res.status(400).json({ message: 'ç™ºä¿¡å…ˆé›»è©±ç•ªå·ã¯å¿…é ˆã§ã™' });
      }
      
      const callService = require('./services/callService');
      const params = {
        phoneNumber,
        callerID: callerID || process.env.DEFAULT_CALLER_ID || '"Auto Dialer" <03-5946-8520>',
        context: 'autodialer',
        exten: 's',
        priority: 1,
        variables: {
          CAMPAIGN_ID: 'TEST',
          CONTACT_ID: 'TEST',
          TEST_CALL: 'true'
        },
        mockMode
      };
      
      const result = await callService.originate(params);
      
      res.json({
        success: true,
        callId: result.ActionID,
        message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ',
        data: result
      });
    } catch (error) {
      console.error('ãƒ†ã‚¹ãƒˆç™ºä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', error: error.message });
    }
  });
}

// 404ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.use((req, res, next) => {
  res.status(404).json({ 
    message: 'è¦æ±‚ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use((err, req, res, next) => {
  console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
  res.status(500).json({ 
    message: 'å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼', 
    error: err.message 
  });
});

// ğŸš€ ä¿®æ­£ç‰ˆ: å®‰å…¨ãªã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‡¦ç†
const startServer = async () => {
  // ğŸ”’ é‡è¤‡èµ·å‹•é˜²æ­¢
  if (isServerStarted) {
    console.log('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã¯æ—¢ã«èµ·å‹•ã•ã‚Œã¦ã„ã¾ã™');
    return;
  }
  
  try {
    console.log('ğŸš€ ã‚µãƒ¼ãƒãƒ¼åˆæœŸåŒ–é–‹å§‹...');
    
    // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
    await db.query('SELECT 1');
    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');

    // 2. åˆ©ç”¨å¯èƒ½ãƒãƒ¼ãƒˆæ¤œç´¢
    const availablePort = await findAvailablePort(5000);
    console.log(`ğŸ” åˆ©ç”¨å¯èƒ½ãƒãƒ¼ãƒˆç™ºè¦‹: ${availablePort}`);
    
    // ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
    process.env.ACTIVE_PORT = availablePort;
    
    // 3. ã‚µãƒ¼ãƒãƒ¼ä½œæˆï¼ˆ1å›ã®ã¿ï¼‰
    if (!server) {
      server = http.createServer(app);
    }
    
    // 4. SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
    console.log('ğŸ”§ SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ä¸­...');
    try {
      const sipService = require('./services/sipService');
      const sipResult = await sipService.connect();
      console.log('ğŸ“ SIPåˆæœŸåŒ–çµæœ:', sipResult);
    } catch (sipError) {
      console.error('âŒ SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', sipError.message);
    }

    // 5. CallServiceåˆæœŸåŒ–
    console.log('ğŸ”§ CallServiceåˆæœŸåŒ–ä¸­...');
    try {
      const callService = require('./services/callService');
      const callResult = await callService.initialize();
      console.log('ğŸ“ CallServiceåˆæœŸåŒ–çµæœ:', callResult);
    } catch (callError) {
      console.error('âŒ CallServiceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', callError.message);
    }

    // 6. DialerServiceåˆæœŸåŒ–
    console.log('ğŸ”§ DialerServiceåˆæœŸåŒ–ä¸­...');
    try {
      const dialerService = require('./services/dialerService');
      dialerService.initialized = true;
      dialerService.enabled = true;
      console.log('âœ… DialerServiceåˆæœŸåŒ–å®Œäº†');
    } catch (dialerError) {
      console.error('âŒ DialerServiceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', dialerError.message);
    }
    
    // 7. ğŸ”¥ ç¢ºå®Ÿãªå˜ä¸€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    await new Promise((resolve, reject) => {
      server.listen(availablePort, '0.0.0.0', (err) => {
        if (err) {
          console.error('âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
          reject(err);
        } else {
          isServerStarted = true;
          console.log(`âœ… ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://0.0.0.0:${availablePort}`);
          console.log('ğŸ¯ è‡ªå‹•ç™ºä¿¡ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
          resolve();
        }
      });
    });
    
  } catch (error) {
    console.error('âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
    isServerStarted = false;
    throw error;
  }
};

// æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection:', reason);
});

process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
});

// çµ‚äº†å‡¦ç†
process.on('SIGINT', async () => {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™...');
  
  try {
    if (server) {
      server.close(() => {
        console.log('ã‚µãƒ¼ãƒãƒ¼ã‚’æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸ');
        process.exit(0);
      });
    }
    
    if (db.close) {
      await db.close();
    }
  } catch (error) {
    console.error('çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  }
});

// ğŸ”¥ å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
if (require.main === module) {
  startServer().catch(err => {
    console.error('startServerå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', err);
    process.exit(1);
  });
}

module.exports = app;
