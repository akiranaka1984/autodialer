// backend/src/index.js - æœ€å¼·ãƒãƒ¼ãƒˆç«¶åˆè§£æ±ºç‰ˆ
const express = require('express');
const cors = require('cors');
const http = require('http');
const net = require('net');

console.log('ğŸš€ AutoDialer æœ€å¼·ç‰ˆèµ·å‹•é–‹å§‹...');

const app = express();

// ğŸ”¥ æœ€å¼·å‹•çš„ãƒãƒ¼ãƒˆæ¤œç´¢æ©Ÿèƒ½
const findAvailablePort = async (startPort = 5000) => {
  console.log(`ğŸ” ãƒãƒ¼ãƒˆæ¤œç´¢é–‹å§‹: ${startPort}ç•ªã‹ã‚‰`);
  
  for (let port = startPort; port <= startPort + 20; port++) {
    try {
      await new Promise((resolve, reject) => {
        const testServer = net.createServer();
        
        testServer.on('error', (err) => {
          console.log(`âŒ ãƒãƒ¼ãƒˆ${port}: ${err.code}`);
          reject(err);
        });
        
        testServer.listen(port, '0.0.0.0', () => {
          console.log(`âœ… ãƒãƒ¼ãƒˆ${port}: åˆ©ç”¨å¯èƒ½`);
          testServer.close(() => resolve(port));
        });
      });
      
      console.log(`ğŸ¯ åˆ©ç”¨å¯èƒ½ãƒãƒ¼ãƒˆç™ºè¦‹: ${port}`);
      return port;
      
    } catch (error) {
      continue;
    }
  }
  
  throw new Error(`ãƒãƒ¼ãƒˆ${startPort}-${startPort + 20}ã™ã¹ã¦ä½¿ç”¨ä¸­`);
};

// ğŸ”’ ã‚°ãƒ­ãƒ¼ãƒãƒ«èµ·å‹•ãƒ•ãƒ©ã‚°
global.SERVER_STARTED = global.SERVER_STARTED || false;
let activeServer = null;

// CORSè¨­å®š
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin'],
  credentials: true
}));

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} ${req.method} ${req.url}`);
  next();
});

console.log('ğŸ”§ ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²é–‹å§‹...');

// å®‰å…¨ãªãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
const safeRouterLoad = (path, file, name) => {
  try {
    delete require.cache[require.resolve(file)];
    const router = require(file);
    app.use(path, router);
    console.log(`âœ… ${name} router æˆåŠŸ`);
    return true;
  } catch (error) {
    console.log(`âš ï¸ ${name} router ã‚¹ã‚­ãƒƒãƒ—:`, error.message);
    return false;
  }
};

// ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
const routers = [
  ['/api/system', './routes/system', 'system'],
  ['/api', './routes/contacts', 'contacts'], 
  ['/api/campaigns', './routes/campaigns', 'campaigns'],
  ['/api/caller-ids', './routes/callerIds', 'callerIds'],
  ['/api/calls', './routes/calls', 'calls'],
  ['/api/audio', './routes/audio', 'audio'],
  ['/api/ivr', './routes/ivr', 'ivr']
];

let loadedRouters = 0;
routers.forEach(([path, file, name]) => {
  if (safeRouterLoad(path, file, name)) {
    loadedRouters++;
  }
});

console.log(`ğŸ“Š ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²å®Œäº†: ${loadedRouters}/${routers.length}`);

// èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/auth/login', (req, res) => {
  const { username, password } = req.body;
  if (username && password) {
    res.json({
      success: true,
      user: { username, role: 'admin', name: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…' },
      token: `token-${Date.now()}`
    });
  } else {
    res.status(400).json({ success: false, message: 'èªè¨¼æƒ…å ±ãŒå¿…è¦ã§ã™' });
  }
});

app.get('/api/auth/profile', (req, res) => {
  res.json({
    id: 1,
    username: 'admin', 
    name: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…',
    role: 'admin'
  });
});

// åŸºæœ¬ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get('/', (req, res) => {
  res.json({
    message: 'AutoDialer API æœ€å¼·ç‰ˆç¨¼åƒä¸­',
    version: '1.4.3-nuclear',
    timestamp: new Date().toISOString(),
    port: process.env.ACTIVE_PORT,
    routers: loadedRouters,
    uptime: process.uptime()
  });
});

app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    port: process.env.ACTIVE_PORT,
    memory: process.memoryUsage(),
    uptime: process.uptime()
  });
});

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ†ã‚¹ãƒˆç™ºä¿¡
app.post('/api/calls/test', async (req, res) => {
  try {
    console.log('ğŸ“ ãƒ†ã‚¹ãƒˆç™ºä¿¡è¦æ±‚:', req.body);
    
    const { phoneNumber, mockMode = true } = req.body;
    
    if (!phoneNumber) {
      return res.status(400).json({ message: 'é›»è©±ç•ªå·ãŒå¿…è¦ã§ã™' });
    }
    
    // ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆSIPã‚µãƒ¼ãƒ“ã‚¹æœªèµ·å‹•ã§ã‚‚å‹•ä½œï¼‰
    const callId = `test-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    
    res.json({
      success: true,
      callId,
      message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡é–‹å§‹ï¼ˆæœ€å¼·ç‰ˆï¼‰',
      data: {
        ActionID: callId,
        phoneNumber,
        timestamp: new Date().toISOString(),
        mode: mockMode ? 'mock' : 'real'
      }
    });
    
  } catch (error) {
    console.error('ãƒ†ã‚¹ãƒˆç™ºä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    res.status(500).json({ 
      success: false,
      message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡å¤±æ•—',
      error: error.message 
    });
  }
});

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§
app.get('/api/campaigns', async (req, res) => {
  try {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    try {
      const db = require('./services/database');
      const [campaigns] = await db.query(`
        SELECT c.id, c.name, c.description, c.status, c.created_at,
               (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count
        FROM campaigns c
        ORDER BY c.created_at DESC
        LIMIT 50
      `);
      
      res.json({
        campaigns: campaigns || [],
        total: campaigns ? campaigns.length : 0
      });
      
    } catch (dbError) {
      console.warn('DBæ¥ç¶šãªã—ã€ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', dbError.message);
      
      // DBãªã—ã§ã‚‚ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§å¿œç­”
      res.json({
        campaigns: [
          {
            id: 28,
            name: 'ãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
            description: 'ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
            status: 'draft',
            created_at: new Date().toISOString(),
            contact_count: 0
          }
        ],
        total: 1,
        message: 'ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆDBæ¥ç¶šãªã—ï¼‰'
      });
    }
    
  } catch (error) {
    console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    res.status(500).json({ 
      campaigns: [],
      total: 0,
      error: error.message 
    });
  }
});

// 404ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.use((req, res) => {
  res.status(404).json({
    message: 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    path: req.originalUrl,
    availableEndpoints: [
      'GET /',
      'GET /health',
      'POST /api/auth/login',
      'GET /api/campaigns',
      'POST /api/calls/test'
    ]
  });
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.use((err, req, res, next) => {
  console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
  res.status(500).json({
    message: 'å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼',
    error: err.message,
    timestamp: new Date().toISOString()
  });
});

// ğŸš€ æœ€å¼·ã‚µãƒ¼ãƒãƒ¼èµ·å‹•é–¢æ•°
const startServerNuclear = async () => {
  if (global.SERVER_STARTED) {
    console.log('âš ï¸ ã‚µãƒ¼ãƒãƒ¼æ—¢ã«èµ·å‹•æ¸ˆã¿');
    return;
  }
  
  try {
    console.log('ğŸš€ æœ€å¼·ç‰ˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‡¦ç†é–‹å§‹...');
    
    // 1. ãƒãƒ¼ãƒˆæ¤œç´¢
    const port = await findAvailablePort(5000);
    process.env.ACTIVE_PORT = port;
    
    // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
    try {
      const db = require('./services/database');
      await db.query('SELECT 1');
      console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');
    } catch (dbError) {
      console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•—ï¼ˆç¶šè¡Œï¼‰:', dbError.message);
    }
    
    // 3. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    activeServer = http.createServer(app);
    
    await new Promise((resolve, reject) => {
      activeServer.listen(port, '0.0.0.0', (err) => {
        if (err) {
          console.error('âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¤±æ•—:', err);
          reject(err);
        } else {
          global.SERVER_STARTED = true;
          console.log(`âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æˆåŠŸ: http://0.0.0.0:${port}`);
          console.log(`ğŸ¯ æœ€å¼·ç‰ˆAutoDialerç¨¼åƒä¸­`);
          resolve();
        }
      });
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
      setTimeout(() => {
        reject(new Error('ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
      }, 10000);
    });
    
  } catch (error) {
    console.error('âŒ æœ€å¼·ç‰ˆèµ·å‹•å¤±æ•—:', error);
    global.SERVER_STARTED = false;
    throw error;
  }
};

// çµ‚äº†å‡¦ç†
const gracefulShutdown = () => {
  console.log('ğŸ›‘ ã‚µãƒ¼ãƒãƒ¼åœæ­¢é–‹å§‹...');
  
  if (activeServer) {
    activeServer.close(() => {
      console.log('âœ… ã‚µãƒ¼ãƒãƒ¼åœæ­¢å®Œäº†');
      process.exit(0);
    });
  } else {
    process.exit(0);
  }
};

process.on('SIGINT', gracefulShutdown);
process.on('SIGTERM', gracefulShutdown);

// ã‚¨ãƒ©ãƒ¼å‡¦ç†
process.on('uncaughtException', (error) => {
  console.error('æœªå‡¦ç†ä¾‹å¤–:', error);
  if (error.code !== 'EPIPE') {
    process.exit(1);
  }
});

process.on('unhandledRejection', (reason) => {
  console.error('æœªå‡¦ç†Promiseæ‹’å¦:', reason);
});

// ğŸ”¥ ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
if (require.main === module) {
  startServerNuclear().catch(err => {
    console.error('èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
    process.exit(1);
  });
}

module.exports = app;
