// backend/src/index.js - DialerServiceä¿®æ­£ç‰ˆï¼ˆå®Œå…¨ç½®æ›ï¼‰
const express = require('express');
const cors = require('cors');
const http = require('http');
const logger = require('./services/logger');
const db = require('./services/database');

require('dotenv').config();

const app = express();
const PORT = parseInt(process.env.PORT || '5000', 10);
const server = http.createServer(app);

// ğŸ”§ è¿½åŠ : HTTPã‚µãƒ¼ãƒãƒ¼å®‰å®šåŒ–è¨­å®š
server.timeout = 30000; // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
server.keepAliveTimeout = 65000; // Keep-Aliveè¨­å®š
server.headersTimeout = 66000; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦

// CORSè¨­å®š
app.use((req, res, next) => {
  const origin = req.headers.origin;
  const allowedOrigins = [
    'http://localhost:3000',
    'http://localhost:3001', 
    'http://localhost:3003',
    'http://127.0.0.1:3003',
    'http://146.190.83.205:3003'
  ];
  
  res.setHeader("Access-Control-Allow-Origin", "*");
  
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, PATCH, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, Cache-Control, Pragma');
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Max-Age', '86400');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  next();
});

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use(express.json({ limit: '10mb', strict: true }));
app.use(express.urlencoded({ extended: true, limit: '10mb', parameterLimit: 1000 }));

// ğŸ”§ æ–°è¦è¿½åŠ : ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·
app.use((req, res, next) => {
  req.setTimeout(25000, () => {
    console.error(`Request timeout: ${req.method} ${req.url}`);
    if (!res.headersSent) {
      res.status(408).json({ error: 'Request timeout' });
    }
  });
  next();
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
app.use((req, res, next) => {
  console.log(`${req.method} ${req.url} - Origin: ${req.headers.origin || 'none'}`);
  next();
});

// âœ… ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
console.log('ğŸš€ ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²é–‹å§‹...');

const routerStatus = {
  system: false,
  contacts: false,
  campaigns: false,
  callerIds: false,
  calls: false,
  audio: false,
  ivr: false
};

// 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const systemRouter = require('./routes/system');
  app.use('/api/system', systemRouter);
  routerStatus.system = true;
  console.log('âœ… system router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ system router ç™»éŒ²å¤±æ•—:', error.message);
}

// 2. é€£çµ¡å…ˆãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const contactsRouter = require('./routes/contacts');
  app.use('/api', contactsRouter);
  routerStatus.contacts = true;
  console.log('âœ… contacts router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ contacts router ç™»éŒ²å¤±æ•—:', error.message);
}

// 3. ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const campaignsRouter = require('./routes/campaigns');
  app.use('/api/campaigns', campaignsRouter);
  routerStatus.campaigns = true;
  console.log('âœ… campaigns router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ campaigns router ç™»éŒ²å¤±æ•—:', error.message);
}

// 4. ç™ºä¿¡è€…ç•ªå·ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const callerIdsRouter = require('./routes/callerIds');
  app.use('/api/caller-ids', callerIdsRouter);
  routerStatus.callerIds = true;
  console.log('âœ… caller-ids router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ caller-ids router ç™»éŒ²å¤±æ•—:', error.message);
}

// 5. é€šè©±ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const callsRouter = require('./routes/calls');
  app.use('/api/calls', callsRouter);
  routerStatus.calls = true;
  console.log('âœ… calls router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ calls router ç™»éŒ²å¤±æ•—:', error.message);
}

// 6. éŸ³å£°ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const audioRouter = require('./routes/audio');
  app.use('/api/audio', audioRouter);
  routerStatus.audio = true;
  console.log('âœ… audio router ç™»éŒ²æˆåŠŸ');
} catch (error) {
  console.error('âŒ audio router ç™»éŒ²å¤±æ•—:', error.message);
}

// 7. IVRãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const ivrRouter = require('./routes/ivr');
  app.use('/api/ivr', ivrRouter);
  routerStatus.ivr = true;
  console.log('âœ… ivr router ç™»éŒ²æˆåŠŸ');

// 8. è»¢é€ãƒ«ãƒ¼ã‚¿ãƒ¼
try {
  const transferRouter = require("./routes/transfer");
  app.use("/api", transferRouter);
  routerStatus.transfer = true;
  console.log("âœ… transfer router ç™»éŒ²æˆåŠŸ");
} catch (error) {
  console.error("âŒ transfer router ç™»éŒ²å¤±æ•—:", error.message);
}
} catch (error) {
  console.error('âŒ ivr router ç™»éŒ²å¤±æ•—:', error.message);
}

console.log('ğŸ“Š ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²çŠ¶æ³:', routerStatus);

// === èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ===
app.post("/api/auth/login", (req, res) => {
  const { username, password } = req.body;
  console.log("ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:", username);
  if (username && password) {
    res.json({
      success: true,
      user: { username: username, role: "admin", name: "ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…" },
      token: "dummy-token-" + Date.now()
    });
  } else {
    res.status(400).json({ success: false, message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™" });
  }
});

app.get("/api/auth/profile", (req, res) => {
  res.json({
    id: 1,
    username: "admin",
    name: "ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…",
    role: "admin"
  });
});


// === åŸºæœ¬ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ===
app.get('/', (req, res) => {
  res.json({ 
    message: 'ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ APIç¨¼åƒä¸­',
    version: '1.4.1',
    timestamp: new Date().toISOString(),
    routerStatus: routerStatus,
    endpoints: [
      '/api/system/health',
      '/api/campaigns',
      '/api/campaigns/:id/contacts',
      '/api/campaigns/:id/contacts/upload',
      '/api/caller-ids', 
      '/api/calls/test',
      '/api/audio',
      '/api/ivr/test-call'
    ]
  });
});

app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    server: 'main',
    routerStatus: routerStatus
  });
});

// === ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬API ===
if (!routerStatus.campaigns) {
  console.log('ğŸ”„ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™»éŒ²ä¸­...');
  
  app.get('/api/campaigns', async (req, res) => {
    try {
      const [campaigns] = await db.query(`
        SELECT c.id, c.name, c.description, c.status, c.created_at, c.updated_at, c.progress,
               ci.number as caller_id_number,
               (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count
        FROM campaigns c
        LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id
        ORDER BY c.created_at DESC
      `);
      
      res.json({
        campaigns: campaigns || [],
        total: campaigns ? campaigns.length : 0,
        page: 1,
        limit: 50,
        totalPages: 1
      });
    } catch (error) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ 
        campaigns: [], 
        total: 0, 
        message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' 
      });
    }
  });

  app.get('/api/campaigns/:id', async (req, res) => {
    try {
      const { id } = req.params;
      
      const [campaigns] = await db.query(`
        SELECT c.*, 
               ci.number as caller_id_number,
               ci.description as caller_id_description,
               (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id) as contact_count
        FROM campaigns c
        LEFT JOIN caller_ids ci ON c.caller_id_id = ci.id
        WHERE c.id = ?
      `, [id]);
      
      if (campaigns.length === 0) {
        return res.status(404).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
      }
      
      res.json(campaigns[0]);
    } catch (error) {
      console.error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è©³ç´°ã‚¨ãƒ©ãƒ¼: ID=${req.params.id}`, error);
      res.status(500).json({ message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });

  app.get('/api/campaigns/:id/stats', async (req, res) => {
    try {
      const { id } = req.params;
      
      const [campaigns] = await db.query('SELECT * FROM campaigns WHERE id = ?', [id]);
      
      if (campaigns.length === 0) {
        return res.status(404).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
      }
      
      const [contactStats] = await db.query(`
        SELECT 
          COUNT(*) as total,
          SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
          SUM(CASE WHEN status = 'called' THEN 1 ELSE 0 END) as called,
          SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
          SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
          SUM(CASE WHEN status = 'dnc' THEN 1 ELSE 0 END) as dnc
        FROM contacts 
        WHERE campaign_id = ?
      `, [id]);
      
      const [callStats] = await db.query(`
        SELECT 
          COUNT(*) as total_calls,
          SUM(CASE WHEN status = 'ANSWERED' THEN 1 ELSE 0 END) as answered_calls,
          AVG(duration) as avg_duration
        FROM call_logs 
        WHERE campaign_id = ?
      `, [id]);
      
      const contactStat = contactStats[0];
      const callStat = callStats[0];
      
      const progress = contactStat.total > 0 
        ? Math.round(((contactStat.completed + contactStat.failed + contactStat.dnc) / contactStat.total) * 100) 
        : 0;
      
      res.json({
        campaignId: parseInt(id),
        campaignName: campaigns[0].name,
        campaignStatus: campaigns[0].status,
        progress,
        contacts: {
          total: contactStat.total,
          pending: contactStat.pending,
          called: contactStat.called,
          completed: contactStat.completed,
          failed: contactStat.failed,
          dnc: contactStat.dnc
        },
        calls: {
          total: callStat.total_calls || 0,
          answered: callStat.answered_calls || 0,
          avgDuration: callStat.avg_duration ? Math.round(callStat.avg_duration) : 0
        }
      });
    } catch (error) {
      console.error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³çµ±è¨ˆã‚¨ãƒ©ãƒ¼: Campaign=${req.params.id}`, error);
      res.status(500).json({ message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });

  app.post('/api/campaigns/:id/start', async (req, res) => {
    try {
      const { id } = req.params;
      
      console.log(`ğŸš€ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹è¦æ±‚: ID=${id}`);
      
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      const [result] = await db.query(
        'UPDATE campaigns SET status = "active", updated_at = NOW() WHERE id = ?',
        [id]
      );
      
      if (result.affectedRows === 0) {
        return res.status(400).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
      }
      
      // ğŸ”¥ DialerServiceã«ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’æ‰‹å‹•ç™»éŒ²
      try {
        const dialerService = require('./services/dialerService');
        
        console.log('ğŸ”„ DialerServiceã¸ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è¿½åŠ ...');
        
        // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’å–å¾—
        const [campaigns] = await db.query(`
          SELECT c.id, c.name, c.max_concurrent_calls, c.caller_id_id,
                 ci.number as caller_id_number
          FROM campaigns c
          JOIN caller_ids ci ON c.caller_id_id = ci.id
          WHERE c.id = ? AND ci.active = true
        `, [id]);
        
        if (campaigns.length > 0) {
          const campaign = campaigns[0];
          
          // DialerServiceã‚’å¼·åˆ¶åˆæœŸåŒ–
          if (!dialerService.initialized) {
            dialerService.initialized = true;
            dialerService.enabled = true;
            dialerService.errorCount = 0;
            dialerService.dialInterval = 5000; // 5ç§’é–“éš”
            console.log('ğŸ”§ DialerServiceå¼·åˆ¶åˆæœŸåŒ–å®Œäº†');
          }
          
          // activeCampaignsã«è¿½åŠ 
          dialerService.activeCampaigns.set(parseInt(id), {
            id: campaign.id,
            name: campaign.name,
            maxConcurrentCalls: Math.min(campaign.max_concurrent_calls || 1, 2),
            callerIdId: campaign.caller_id_id,
            callerIdNumber: campaign.caller_id_number,
            activeCalls: 0,
            status: 'active',
            lastDialTime: null,
            failCount: 0
          });
          
          console.log(`âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${id}ã‚’DialerServiceã«è¿½åŠ `);
          
          // è‡ªå‹•ç™ºä¿¡ã‚¸ãƒ§ãƒ–é–‹å§‹
          if (!dialerService.dialerIntervalId) {
            dialerService.startDialerJobSafe();
            console.log('ğŸš€ è‡ªå‹•ç™ºä¿¡ã‚¸ãƒ§ãƒ–é–‹å§‹');
          }
          
        } else {
          console.warn(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${id}ã®è©³ç´°å–å¾—å¤±æ•—`);
        }
        
      } catch (dialerError) {
        console.error('DialerServiceè¿½åŠ ã‚¨ãƒ©ãƒ¼:', dialerError.message);
      }
      
      res.json({
        success: true,
        message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ',
        campaignId: parseInt(id)
      });
      
    } catch (error) {
      console.error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼: ID=${req.params.id}`, error);
      res.status(500).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });

  app.post('/api/campaigns/:id/stop', async (req, res) => {
    try {
      const { id } = req.params;
      
      const [result] = await db.query(
        'UPDATE campaigns SET status = "paused", updated_at = NOW() WHERE id = ?',
        [id]
      );
      
      if (result.affectedRows === 0) {
        return res.status(400).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
      }
      
      // DialerServiceã‹ã‚‰ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’å‰Šé™¤
      try {
        const dialerService = require('./services/dialerService');
        dialerService.activeCampaigns.delete(parseInt(id));
        console.log(`ğŸ›‘ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${id}ã‚’DialerServiceã‹ã‚‰å‰Šé™¤`);
        
        // ä»–ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒãªã‘ã‚Œã°ã‚¸ãƒ§ãƒ–åœæ­¢
        if (dialerService.activeCampaigns.size === 0) {
          dialerService.stopDialerJob();
          console.log('ğŸ›‘ è‡ªå‹•ç™ºä¿¡ã‚¸ãƒ§ãƒ–åœæ­¢');
        }
      } catch (dialerError) {
        console.error('DialerServiceåœæ­¢ã‚¨ãƒ©ãƒ¼:', dialerError.message);
      }
      
      res.json({
        success: true,
        message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ',
        campaignId: parseInt(id)
      });
    } catch (error) {
      console.error(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åœæ­¢ã‚¨ãƒ©ãƒ¼: ID=${req.params.id}`, error);
      res.status(500).json({ message: 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });
}

// ç™ºä¿¡è€…ç•ªå·ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
if (!routerStatus.callerIds) {
  app.get('/api/caller-ids', async (req, res) => {
    try {
      const [callerIds] = await db.query('SELECT * FROM caller_ids WHERE active = 1 ORDER BY created_at DESC');
      res.json(callerIds);
    } catch (error) {
      console.error('ç™ºä¿¡è€…ç•ªå·å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ message: 'ç™ºä¿¡è€…ç•ªå·ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    }
  });
}

// ãƒ†ã‚¹ãƒˆç™ºä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
if (!routerStatus.calls) {
  app.post('/api/calls/test', async (req, res) => {
    try {
      const { phoneNumber, callerID, mockMode } = req.body;
      
      if (!phoneNumber) {
        return res.status(400).json({ message: 'ç™ºä¿¡å…ˆé›»è©±ç•ªå·ã¯å¿…é ˆã§ã™' });
      }
      
      // å®Ÿéš›ã®SIPç™ºä¿¡ã‚’å®Ÿè¡Œ
      const callService = require('./services/callService');
      const params = {
        phoneNumber,
        callerID: callerID || process.env.DEFAULT_CALLER_ID || '"Auto Dialer" <03-5946-8520>',
        context: 'autodialer',
        exten: 's',
        priority: 1,
        variables: {
          CAMPAIGN_ID: 'TEST',
          CONTACT_ID: 'TEST',
          TEST_CALL: 'true'
        },
        mockMode
      };
      
      const result = await callService.originate(params);
      
      res.json({
        success: true,
        callId: result.ActionID,
        message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ',
        data: result
      });
    } catch (error) {
      console.error('ãƒ†ã‚¹ãƒˆç™ºä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      res.status(500).json({ message: 'ãƒ†ã‚¹ãƒˆç™ºä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', error: error.message });
    }
  });
}

// 404ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
app.use((req, res, next) => {
  console.log(`âŒ 404 Not Found: ${req.method} ${req.originalUrl}`);
  res.status(404).json({ 
    message: 'è¦æ±‚ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use((err, req, res, next) => {
  console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
  res.status(500).json({ 
    message: 'å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼', 
    error: err.message 
  });
});

// ğŸ”¥ ä¿®æ­£ç‰ˆ: å¼·åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼èµ·å‹•å‡¦ç†
const startServer = async () => {
  try {
    console.log('ğŸš€ ã‚µãƒ¼ãƒãƒ¼åˆæœŸåŒ–é–‹å§‹...');
    
    // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
    await db.query('SELECT 1');
    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');

    // 2. SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
    console.log('ğŸ”§ SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ä¸­...');
    try {
      const sipService = require('./services/sipService');
      const sipResult = await sipService.connect();
      console.log('ğŸ“ SIPåˆæœŸåŒ–çµæœ:', sipResult);
      console.log('ğŸ“ SIPã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ•°:', sipService.getAvailableSipAccountCount());
    } catch (sipError) {
      console.error('âŒ SIPã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', sipError.message);
    }

    // 3. CallServiceåˆæœŸåŒ–
    console.log('ğŸ”§ CallServiceåˆæœŸåŒ–ä¸­...');
    try {
      const callService = require('./services/callService');
      const callResult = await callService.initialize();
      console.log('ğŸ“ CallServiceåˆæœŸåŒ–çµæœ:', callResult);
    } catch (callError) {
      console.error('âŒ CallServiceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', callError.message);
    }

    // 4. DialerServiceæ‰‹å‹•åˆæœŸåŒ–ï¼ˆé‡è¦ï¼ï¼‰
    console.log('ğŸ”§ DialerServiceæ‰‹å‹•åˆæœŸåŒ–ä¸­...');
    try {
      const dialerService = require('./services/dialerService');
      
      // ğŸ”¥ å¼·åˆ¶çš„ã«åŸºæœ¬è¨­å®š
      dialerService.initialized = true;
      dialerService.enabled = true;
      dialerService.errorCount = 0;
      dialerService.dialInterval = 5000; // 5ç§’é–“éš”
      dialerService.isProcessing = false;
      
      console.log('âœ… DialerServiceæ‰‹å‹•åˆæœŸåŒ–å®Œäº†');
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ç¢ºèªã—ã¦è‡ªå‹•é–‹å§‹
      setTimeout(async () => {
        try {
          const [activeCampaigns] = await db.query(`
            SELECT c.id, c.name, c.max_concurrent_calls, c.caller_id_id,
                   ci.number as caller_id_number,
                   (SELECT COUNT(*) FROM contacts WHERE campaign_id = c.id AND status = 'pending') as pending_count
            FROM campaigns c
            JOIN caller_ids ci ON c.caller_id_id = ci.id
            WHERE c.status = 'active' AND ci.active = true
          `);
          
          console.log(`ğŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ¤œå‡º: ${activeCampaigns.length}ä»¶`);
          
          if (activeCampaigns.length > 0) {
            console.log('ğŸ”„ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’è‡ªå‹•ç™»éŒ²...');
            
            activeCampaigns.forEach(campaign => {
              if (campaign.pending_count > 0) {
                dialerService.activeCampaigns.set(campaign.id, {
                  id: campaign.id,
                  name: campaign.name,
                  maxConcurrentCalls: Math.min(campaign.max_concurrent_calls || 1, 2),
                  callerIdId: campaign.caller_id_id,
                  callerIdNumber: campaign.caller_id_number,
                  activeCalls: 0,
                  status: 'active',
                  lastDialTime: null,
                  failCount: 0
                });
                
                console.log(`âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${campaign.id} "${campaign.name}" è‡ªå‹•ç™»éŒ² (æœªå‡¦ç†: ${campaign.pending_count}ä»¶)`);
              }
            });
            
            // è‡ªå‹•ç™ºä¿¡ã‚¸ãƒ§ãƒ–é–‹å§‹
            if (dialerService.activeCampaigns.size > 0) {
              dialerService.startDialerJobSafe();
              console.log('ğŸš€ è‡ªå‹•ç™ºä¿¡ã‚¸ãƒ§ãƒ–è‡ªå‹•é–‹å§‹');
            }
          }
          
        } catch (autoStartError) {
          console.error('è‡ªå‹•é–‹å§‹ã‚¨ãƒ©ãƒ¼:', autoStartError.message);
        }
      }, 5000); // 5ç§’å¾Œã«å®Ÿè¡Œ
      
    } catch (dialerError) {
      console.error('âŒ DialerServiceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', dialerError.message);
    }
    
    // 6. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    server.listen(PORT, '0.0.0.0', () => {
      console.log(`âœ… ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://0.0.0.0:${PORT}`);
      console.log('ğŸ¯ è‡ªå‹•ç™ºä¿¡ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
      console.log('ğŸ”— åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:');
      console.log('  - GET  /health');
      console.log('  - GET  /api/campaigns');
      console.log('  - POST /api/campaigns/:id/start');
      console.log('  - POST /api/calls/test');
    });
    // ğŸ”¥ DialerServiceè‡ªå‹•é–‹å§‹ã®å¼·åŒ–ï¼ˆæ’ä¹…çš„ä¿®æ­£ï¼‰
    console.log('ğŸ”§ DialerServiceå¼·åˆ¶è‡ªå‹•é–‹å§‹...');
    try {
      const dialerService = require('./services/dialerService');
      
      // å¼·åˆ¶çš„ã«æœ‰åŠ¹åŒ–
      dialerService.enabled = true;
      dialerService.isProcessing = false;
      
      // 10ç§’å¾Œã«è‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹ï¼ˆä»–ã®åˆæœŸåŒ–å®Œäº†å¾Œï¼‰
      setTimeout(async () => {
        try {
          if (typeof dialerService.startAutoSystem === 'function') {
            await dialerService.startAutoSystem();
            console.log('âœ… DialerServiceè‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹å®Œäº†');
          } else {
            console.log('âš ï¸ startAutoSystem ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        } catch (autoStartError) {
          console.error('DialerServiceè‡ªå‹•é–‹å§‹ã‚¨ãƒ©ãƒ¼:', autoStartError.message);
          
          // 30ç§’å¾Œã«å†è©¦è¡Œ
          setTimeout(async () => {
            try {
              await dialerService.startAutoSystem();
              console.log('âœ… DialerServiceè‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ å†è©¦è¡ŒæˆåŠŸ');
            } catch (retryError) {
              console.error('DialerServiceå†è©¦è¡Œå¤±æ•—:', retryError.message);
            }
          }, 30000);
        }
      }, 10000);
      
    } catch (dialerError) {
      console.error('DialerServiceåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', dialerError.message);
    }
    
  } catch (error) {
    console.error('âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
    //process.exit(1);
  }
};

// æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection:', reason);
});

process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
  if (process.env.NODE_ENV === 'production') {
   // process.exit(1);
  }
});

// çµ‚äº†å‡¦ç†
process.on('SIGINT', async () => {
  console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™...');
  
  try {
    if (db.close) {
      await db.close();
    }
    
    server.close(() => {
      console.log('ã‚µãƒ¼ãƒãƒ¼ã‚’æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸ');
      process.exit(0);
    });
  } catch (error) {
    console.error('çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  }
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Ÿè¡Œ
startServer().catch(err => {
  console.error('startServerå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', err);
  process.exit(1);
});

