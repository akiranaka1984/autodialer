// ========================================
// backend/src/services/leadService.js
// ========================================
// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹è¾¼ã¿å®¢ã‚’åˆ¤å®šã™ã‚‹ã€Œé ­è„³ã€ã®éƒ¨åˆ†ã§ã™

const db = require('./database');
const logger = require('./logger');

class LeadService {
  
  // ========================================
  // 1. ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è¨­å®šã‚’å–å¾—ã™ã‚‹
  // ========================================
  async getCampaignSettings(campaignId) {
    try {
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è¨­å®šã‚’å–å¾—
      const [settings] = await db.query(
        'SELECT * FROM lead_settings WHERE campaign_id = ?',
        [campaignId]
      );
      
      // è¨­å®šãŒç„¡ã‘ã‚Œã°åˆæœŸå€¤ã‚’ä½œã‚‹
      if (settings.length === 0) {
        await this.createDefaultSettings(campaignId);
        return { 
          campaign_id: campaignId, 
          threshold_seconds: 15,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯15ç§’
          enabled: true 
        };
      }
      
      return settings[0];
    } catch (error) {
      logger.error('è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  // ========================================
  // 2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½œæˆ
  // ========================================
  async createDefaultSettings(campaignId) {
    try {
      await db.query(
        'INSERT INTO lead_settings (campaign_id, threshold_seconds, enabled) VALUES (?, 15, TRUE)',
        [campaignId]
      );
      logger.info(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${campaignId}ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆ15ç§’ï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸ`);
    } catch (error) {
      logger.error('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ========================================
  // 3. è¨­å®šã‚’æ›´æ–°ã™ã‚‹ï¼ˆ5ç§’ã€10ç§’ã€15ç§’ãªã©å¤‰æ›´å¯èƒ½ï¼‰
  // ========================================
  async updateCampaignSettings(campaignId, thresholdSeconds) {
    try {
      // å…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼š5ã€œ60ç§’ã®é–“ã®ã¿è¨±å¯
      if (thresholdSeconds < 5 || thresholdSeconds > 60) {
        throw new Error('è¨­å®šå¯èƒ½ãªç§’æ•°ã¯5ã€œ60ç§’ã§ã™');
      }
      
      // è¨­å®šã‚’æ›´æ–°
      await db.query(
        'UPDATE lead_settings SET threshold_seconds = ? WHERE campaign_id = ?',
        [thresholdSeconds, campaignId]
      );
      
      logger.info(`âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³${campaignId}ã®åˆ¤å®šç§’æ•°ã‚’${thresholdSeconds}ç§’ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
      
      return { success: true, message: `è¨­å®šã‚’${thresholdSeconds}ç§’ã«å¤‰æ›´ã—ã¾ã—ãŸ` };
      
    } catch (error) {
      logger.error('è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  // ========================================
  // 4. é€šè©±çµ‚äº†æ™‚ã«è¦‹è¾¼ã¿å®¢ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹ï¼ˆæœ€é‡è¦ï¼ï¼‰
  // ========================================
  async processCallEnd(callData) {
    try {
      const { campaign_id, phone_number, duration } = callData;
      
      // Step 1: ãã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è¨­å®šã‚’å–å¾—
      const settings = await this.getCampaignSettings(campaign_id);
      
      if (!settings.enabled) {
        logger.info('è¦‹è¾¼ã¿å®¢åˆ¤å®šæ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      
      // Step 2: è¨­å®šç§’æ•°ã¨æ¯”è¼ƒã—ã¦åˆ¤å®š
      const thresholdSeconds = settings.threshold_seconds;
      const isQualified = duration >= thresholdSeconds;
      
      logger.info(`ğŸ“ é€šè©±çµ‚äº†å‡¦ç†`);
      logger.info(`  ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³: ${campaign_id}`);
      logger.info(`  é›»è©±ç•ªå·: ${phone_number}`);
      logger.info(`  é€šè©±æ™‚é–“: ${duration}ç§’`);
      logger.info(`  åˆ¤å®šåŸºæº–: ${thresholdSeconds}ç§’`);
      logger.info(`  åˆ¤å®šçµæœ: ${isQualified ? 'â­è¦‹è¾¼ã¿å®¢ï¼' : 'âŒå¯¾è±¡å¤–'}`);
      
      // Step 3: è¦‹è¾¼ã¿å®¢ãªã‚‰è¨˜éŒ²ã™ã‚‹
      if (isQualified) {
        await this.addToHotLeads(campaign_id, phone_number, duration);
      }
      
      // Step 4: é€šè©±è¨˜éŒ²ã‚’æ›´æ–°ï¼ˆå…¨ã¦ã®é€šè©±ï¼‰
      await this.updateCallStats(campaign_id, phone_number, duration);
      
    } catch (error) {
      logger.error('é€šè©±çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚é€šè©±å‡¦ç†ã¯ç¶šè¡Œ
    }
  }

  // ========================================
  // 5. è¦‹è¾¼ã¿å®¢ãƒªã‚¹ãƒˆã«è¿½åŠ 
  // ========================================
  async addToHotLeads(campaignId, phoneNumber, duration) {
    try {
      // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç°¡å˜ãªãƒ­ã‚¸ãƒƒã‚¯ï¼‰
      let score = 0;
      if (duration >= 30) score = 100;      // 30ç§’ä»¥ä¸Š = 100ç‚¹
      else if (duration >= 20) score = 80;  // 20ç§’ä»¥ä¸Š = 80ç‚¹
      else if (duration >= 15) score = 60;  // 15ç§’ä»¥ä¸Š = 60ç‚¹
      else if (duration >= 10) score = 40;  // 10ç§’ä»¥ä¸Š = 40ç‚¹
      else score = 20;                      // ãã‚Œä»¥ä¸‹ = 20ç‚¹
      
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆæ—¢ã«ã‚ã‚Œã°æ›´æ–°ï¼‰
      await db.query(`
        INSERT INTO hot_leads 
        (campaign_id, phone_number, max_duration, first_call_duration, lead_score, is_qualified, qualified_at, last_call_date)
        VALUES (?, ?, ?, ?, ?, TRUE, NOW(), NOW())
        ON DUPLICATE KEY UPDATE
          max_duration = GREATEST(max_duration, ?),
          lead_score = GREATEST(lead_score, ?),
          is_qualified = TRUE,
          call_count = call_count + 1,
          last_call_date = NOW()
      `, [
        campaignId, phoneNumber, duration, duration, score,
        duration, score
      ]);
      
      logger.info(`â­ è¦‹è¾¼ã¿å®¢ãƒªã‚¹ãƒˆã«è¿½åŠ : ${phoneNumber} (ã‚¹ã‚³ã‚¢: ${score}ç‚¹)`);
      
    } catch (error) {
      logger.error('è¦‹è¾¼ã¿å®¢è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ========================================
  // 6. é€šè©±çµ±è¨ˆã‚’æ›´æ–°
  // ========================================
  async updateCallStats(campaignId, phoneNumber, duration) {
    try {
      // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const [existing] = await db.query(
        'SELECT * FROM hot_leads WHERE campaign_id = ? AND phone_number = ?',
        [campaignId, phoneNumber]
      );
      
      if (existing.length > 0) {
        // æ›´æ–°
        await db.query(`
          UPDATE hot_leads 
          SET 
            max_duration = GREATEST(max_duration, ?),
            call_count = call_count + 1,
            last_call_date = NOW()
          WHERE campaign_id = ? AND phone_number = ?
        `, [duration, campaignId, phoneNumber]);
      }
      
    } catch (error) {
      logger.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ========================================
  // 7. è¦‹è¾¼ã¿å®¢ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è¨­å®šç§’æ•°ã§è‡ªå‹•åˆ¤å®šï¼‰
  // ========================================
  async getHotLeads(campaignId, options = {}) {
    try {
      // ãã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®è¨­å®šã‚’å–å¾—
      const settings = await this.getCampaignSettings(campaignId);
      const thresholdSeconds = settings.threshold_seconds;
      
      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
      const limit = options.limit || 100;
      const offset = options.offset || 0;
      const customThreshold = options.customThreshold || thresholdSeconds;
      
      // è¦‹è¾¼ã¿å®¢ã‚’å–å¾—
      const [leads] = await db.query(`
        SELECT 
          h.*,
          c.name as contact_name,
          c.company,
          ? as threshold_used
        FROM hot_leads h
        LEFT JOIN contacts c ON h.phone_number = c.phone
        WHERE h.campaign_id = ?
          AND h.max_duration >= ?
        ORDER BY h.lead_score DESC, h.max_duration DESC
        LIMIT ? OFFSET ?
      `, [customThreshold, campaignId, customThreshold, limit, offset]);
      
      // çµ±è¨ˆæƒ…å ±ã‚‚å–å¾—
      const [stats] = await db.query(`
        SELECT 
          COUNT(*) as total_qualified,
          AVG(max_duration) as avg_duration,
          MAX(max_duration) as max_duration
        FROM hot_leads 
        WHERE campaign_id = ? AND max_duration >= ?
      `, [campaignId, customThreshold]);
      
      return {
        campaign_id: campaignId,
        threshold_seconds: customThreshold,
        leads: leads,
        stats: stats[0],
        count: leads.length
      };
      
    } catch (error) {
      logger.error('è¦‹è¾¼ã¿å®¢ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  // ========================================
  // 8. CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—
  // ========================================
  async exportHotLeads(campaignId, thresholdSeconds = null) {
    try {
      // è¨­å®šç§’æ•°ã‚’å–å¾—ï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      if (!thresholdSeconds) {
        const settings = await this.getCampaignSettings(campaignId);
        thresholdSeconds = settings.threshold_seconds;
      }
      
      const [leads] = await db.query(`
        SELECT 
          h.phone_number as 'é›»è©±ç•ªå·',
          c.name as 'æ°å',
          c.company as 'ä¼šç¤¾å',
          h.max_duration as 'æœ€é•·è´å–æ™‚é–“ï¼ˆç§’ï¼‰',
          h.lead_score as 'ã‚¹ã‚³ã‚¢',
          h.call_count as 'ã‚³ãƒ¼ãƒ«å›æ•°',
          h.last_call_date as 'æœ€çµ‚ã‚³ãƒ¼ãƒ«æ—¥æ™‚',
          h.status as 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        FROM hot_leads h
        LEFT JOIN contacts c ON h.phone_number = c.phone
        WHERE h.campaign_id = ?
          AND h.max_duration >= ?
        ORDER BY h.lead_score DESC
      `, [campaignId, thresholdSeconds]);
      
      return leads;
      
    } catch (error) {
      logger.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }
}

// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã„å›ã™ï¼‰
module.exports = new LeadService();
