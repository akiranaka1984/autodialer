// backend/src/services/ivrService.js - 完全実装版（100%完成）
		const logger = require('./logger');
const fs = require('fs').promises;
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');
const execAsync = promisify(exec);
const audioService = require('./audioService');
const db = require('./database');

class IvrService {
  constructor() {
    this.ivrDir = process.env.IVR_SCRIPTS_DIR || path.join(__dirname, '../../ivr-scripts');
    this.initialize();
  }

  async initialize() {
    try {
      // IVRスクリプトディレクトリの存在確認、なければ作成
      await fs.mkdir(this.ivrDir, { recursive: true });
      logger.info(`IVRスクリプトディレクトリを初期化しました: ${this.ivrDir}`);
    } catch (error) {
      logger.error('IVRスクリプトディレクトリの初期化エラー:', error);
    }
  }

  // キャンペーン用のIVRスクリプトを生成
  async generateIvrScript(campaignId) {
    try {
      // キャンペーン情報を取得
      const [campaigns] = await db.query(
	'SELECT c.id, c.name, ci.number as caller_id_number, ci.domain FROM campaigns c JOIN caller_ids ci ON c.caller_id_id = ci.id WHERE c.id = ?',
        [campaignId]
      );
      
      if (campaigns.length === 0) {
        throw new Error('キャンペーンが見つかりません');
      }
      
      const campaign = campaigns[0];
      
      // キャンペーンの音声ファイルを取得
      const audioFiles = await audioService.getCampaignAudio(campaignId);
      
      // 音声ファイルをタイプごとにマッピング
      const audioMap = Array.isArray(audioFiles) ? audioFiles.reduce((map, audio) => {
        if (audio && audio.audio_type) {
          map[audio.audio_type] = audio;
        }
        return map;
      }, {}) : {};
      
      // IVRスクリプトの内容を生成
      let scriptContent = `; IVR Script for Campaign: ${campaign.name} (ID: ${campaignId})\n\n`;
      
      scriptContent += `[autodialer-campaign-${campaignId}]\n`;
      
      // 初期挨拶（welcome）
      if (audioMap.welcome) {
        scriptContent += `exten => s,1,Answer()\n`;
        scriptContent += `  same => n,Wait(1)\n`;
        scriptContent += `  same => n,Playback(${path.basename(audioMap.welcome.filename, path.extname(audioMap.welcome.filename))})\n`;
      } else {
        scriptContent += `exten => s,1,Answer()\n`;
        scriptContent += `  same => n,Wait(1)\n`;
	scriptContent += `  same => n,Playback(vm-tempgreeting)\n`;
      }
      
      // メニュー案内（menu）
      if (audioMap.menu) {
        scriptContent += `  same => n,Playback(${path.basename(audioMap.menu.filename, path.extname(audioMap.menu.filename))})\n`;
      } else {
　　　　scriptContent += `  same => n,Playback(vm-tempgreeting)\n`;
      }
      
      // キー入力待機
      scriptContent += `  same => n,WaitExten(10)\n\n`;
      
      // 1キー: オペレーター接続
      scriptContent += `exten => 1,1,NoOp(Operator transfer requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=1)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`;
      
      // 2キー: オペレーター接続
      scriptContent += `exten => 2,1,NoOp(Operator transfer requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=2)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`;
      
      // 3キー: オペレーター接続
      scriptContent += `exten => 3,1,NoOp(Operator transfer requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=3)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`;
      
      // 9キー: 通話終了（DNCリストに追加）
      scriptContent += `exten => 9,1,NoOp(DNC requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=9)\n`;
      scriptContent += `  same => n,Playback(custom/dnc-confirmation)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // タイムアウトやその他のキー入力
      scriptContent += `exten => t,1,NoOp(Timeout occurred)\n`;
      
      if (audioMap.goodbye) {
        scriptContent += `  same => n,Playback(${path.basename(audioMap.goodbye.filename, path.extname(audioMap.goodbye.filename))})\n`;
      } else {
	scriptContent += `  same => n,Playback(goodbye)\n`;
      }
      
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // 無効なキー入力
      scriptContent += `exten => i,1,NoOp(Invalid input)\n`;
      
      if (audioMap.error) {
        scriptContent += `  same => n,Playback(${path.basename(audioMap.error.filename, path.extname(audioMap.error.filename))})\n`;
      } else {
        scriptContent += `  same => n,Playback(custom/invalid-option)\n`;
      }
      
      scriptContent += `  same => n,Goto(s,4)\n\n`;
      
      // 通話終了時の処理
      scriptContent += `exten => h,1,NoOp(Hangup handler)\n`;
      scriptContent += `  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=${campaignId}-\${UNIQUEID}&duration=\${ANSWEREDTIME}&disposition=\${DIALSTATUS}&keypress=\${KEYPRESS}")\n`;
      
      // operator-transferコンテキスト追加
      scriptContent += `\n; operator-transfer context\n`;
      scriptContent += `[operator-transfer-${campaignId}]\n`;
      scriptContent += `exten => s,1,NoOp(=== OPERATOR TRANSFER ===)\n`;
      scriptContent += `  same => n,Set(TRANSFER_CALL_ID=\${UNIQUEID})\n`;
      scriptContent += `  same => n,Set(TRANSFER_CAMPAIGN_ID=\${CAMPAIGN_ID})\n`;
      scriptContent += `  same => n,Set(CONTACT_PHONE=\${CALLERID(num)})\n`;
      scriptContent += `  same => n,System(/usr/local/bin/transfer_notify.sh "\${TRANSFER_CALL_ID}" "\${TRANSFER_CAMPAIGN_ID}" "\${KEYPRESS}" "\${CONTACT_PHONE}")\n`;
      scriptContent += `  same => n,Playback(custom/transfer-to-operator)\n`;
      scriptContent += `  same => n,Transfer(SIP/${campaign.caller_id_number}@${campaign.domain})\n`;
      scriptContent += `  same => n,NoOp(Transfer failed)\n`;
      scriptContent += `  same => n,Playback(custom/transfer-failed)\n`;
      scriptContent += `  same => n,Hangup()\n`;
      
      // ファイルに保存
      const scriptPath = path.join(this.ivrDir, `campaign-${campaignId}.conf`);
      await fs.writeFile(scriptPath, scriptContent);
      
      logger.info(`キャンペーンIVRスクリプトを生成しました: ${scriptPath}`);
      
      return {
        path: scriptPath,
        content: scriptContent
      };
    } catch (error) {
      logger.error(`IVRスクリプト生成エラー: Campaign=${campaignId}`, error);
      throw error;
    }
  }

  // デフォルトのIVRスクリプトを生成（テスト発信用）
  async generateDefaultIvrScript() {
    try {
      let scriptContent = `; Default IVR Script for Test Calls\n\n`;
      
      scriptContent += `[autodialer-test]\n`;
      scriptContent += `exten => s,1,Answer()\n`;
      scriptContent += `  same => n,Wait(1)\n`;
      scriptContent += `  same => n,Playback(custom/test-welcome)\n`;
      scriptContent += `  same => n,Playback(custom/test-menu)\n`;
      scriptContent += `  same => n,WaitExten(10)\n\n`;
      
      // 1キー: オペレーター接続
      scriptContent += `exten => 1,1,NoOp(Operator transfer requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=test)\n`;
      scriptContent += `  same => n,Set(KEYPRESS=1)\n`;
      scriptContent += `  same => n,Playback(custom/transfer-to-operator)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // 9キー: 通話終了（DNCリストに追加）
      scriptContent += `exten => 9,1,NoOp(DNC requested)\n`;
      scriptContent += `  same => n,Set(KEYPRESS=9)\n`;
      scriptContent += `  same => n,Playback(custom/dnc-confirmation)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // タイムアウトやその他のキー入力
      scriptContent += `exten => t,1,NoOp(Timeout occurred)\n`;
      scriptContent += `  same => n,Playback(custom/default-goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // 無効なキー入力
      scriptContent += `exten => i,1,NoOp(Invalid input)\n`;
      scriptContent += `  same => n,Playback(custom/invalid-option)\n`;
      scriptContent += `  same => n,Goto(s,4)\n\n`;
      
      // 通話終了時の処理
      scriptContent += `exten => h,1,NoOp(Hangup handler)\n`;
      scriptContent += `  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=test-\${UNIQUEID}&duration=\${ANSWEREDTIME}&disposition=\${DIALSTATUS}&keypress=\${KEYPRESS}")\n`;
      
      // ファイルに保存
      const scriptPath = path.join(this.ivrDir, 'default-test.conf');
      await fs.writeFile(scriptPath, scriptContent);
      
      logger.info(`デフォルトIVRスクリプトを生成しました: ${scriptPath}`);
      
      return {
        path: scriptPath,
        content: scriptContent
      };
    } catch (error) {
      logger.error('デフォルトIVRスクリプト生成エラー:', error);
      throw error;
    }
  }

  // IVRスクリプトをファイルに保存
  async saveIvrScript(campaignId, script) {
    try {
      if (!script) {
        logger.warn(`空のスクリプト内容です: キャンペーンID ${campaignId}`);
        return false;
      }
      
      const scriptPath = path.join(this.ivrDir, `campaign-${campaignId}.conf`);
      await fs.writeFile(scriptPath, script);
      
      logger.info(`IVRスクリプトを保存しました: ${scriptPath}`);
      
      return {
        path: scriptPath,
        success: true
      };
    } catch (error) {
      logger.error(`IVRスクリプト保存エラー: ${error.message}`);
      throw error;
    }
  }

  async deployIvrScripts() {
    try {
      logger.info('全キャンペーンのIVRスクリプトをデプロイ中...');
      
      // アクティブなキャンペーンを取得
      const [campaigns] = await db.query(`
        SELECT id, name FROM campaigns 
        WHERE status IN ('active', 'paused') 
        ORDER BY id
      `);
      
      if (campaigns.length === 0) {
        logger.info('デプロイ対象のキャンペーンがありません');
        return true;
      }
      
      let successCount = 0;
      let errorCount = 0;
      
      // 各キャンペーンのIVRスクリプトをデプロイ
      for (const campaign of campaigns) {
        try {
          await this.deployIvrScript(campaign.id);
          successCount++;
          logger.info(`キャンペーン ${campaign.id} (${campaign.name}) デプロイ成功`);
        } catch (error) {
          errorCount++;
          logger.error(`キャンペーン ${campaign.id} (${campaign.name}) デプロイ失敗:`, error.message);
        }
      }
      
      logger.info(`IVRスクリプト一括デプロイ完了: 成功=${successCount}, 失敗=${errorCount}`);
      return true;
    } catch (error) {
      logger.error('IVRスクリプト一括デプロイエラー:', error);
      throw error;
    }
  }

  // 🚀 完全実装版: 個別キャンペーン用のIVRスクリプトデプロイ（100%完成）
  async deployIvrScript(campaignId) {
    try {
      logger.info(`🚀 キャンペーン ${campaignId} のIVRスクリプト完全デプロイ開始...`);
      
      // Step 1: IVRスクリプト生成
      logger.info(`📝 Step 1: IVRスクリプト生成中...`);
      const scriptResult = await this.generateIvrScript(campaignId);
      
      if (!scriptResult || !scriptResult.path) {
        throw new Error('IVRスクリプトの生成に失敗しました');
      }
      
      const scriptPath = scriptResult.path;
      const scriptFileName = path.basename(scriptPath);
      
      logger.info(`✅ IVRスクリプト生成完了: ${scriptPath}`);
      
      // Step 2: extensions.confへのinclude追加（重複チェック付き）
      logger.info(`📝 Step 2: extensions.confへのinclude追加中...`);
      const includeAdded = await this.addIncludeToExtensionsConf(scriptFileName, campaignId);
      
      if (!includeAdded) {
        logger.info(`ℹ️ include追加スキップ（既存または不要）`);
      }
      
      // Step 3: Asterisk dialplan reload
      logger.info(`📝 Step 3: Asterisk dialplan reload実行中...`);
      const reloadSuccess = await this.reloadAsteriskDialplan();
      
      if (!reloadSuccess) {
        logger.warn('⚠️ Asterisk dialplan reloadに失敗しましたが、処理を続行します');
      }
      
      // Step 4: デプロイ状態をデータベースに記録
      logger.info(`📝 Step 4: データベース記録中...`);
      try {
        await db.query(
          'UPDATE campaigns SET ivr_deployed = true, ivr_deploy_time = NOW() WHERE id = ?',
          [campaignId]
        );
        logger.info(`✅ データベース記録完了`);
      } catch (dbError) {
        logger.warn('⚠️ データベース記録エラー（処理は続行）:', dbError.message);
      }
      
      // Step 5: デプロイ検証
      logger.info(`📝 Step 5: デプロイ検証中...`);
      const contextExists = await this.verifyIvrContext(campaignId);
      
      if (contextExists) {
        logger.info(`✅ キャンペーン ${campaignId} のIVRスクリプト完全デプロイ成功！`);
        logger.info(`🎯 コンテキスト "autodialer-campaign-${campaignId}" がAsteriskに正常登録されました`);
      } else {
        logger.warn(`⚠️ コンテキスト検証失敗 - 手動確認が必要です`);
      }
      
      return {
        success: true,
        scriptPath: scriptPath,
        contextName: `autodialer-campaign-${campaignId}`,
        includeAdded: includeAdded,
        reloadSuccess: reloadSuccess,
        verified: contextExists,
        message: `キャンペーン ${campaignId} のIVRスクリプトが完全デプロイされました`
      };
      
    } catch (error) {
      logger.error(`❌ IVRスクリプト完全デプロイエラー: Campaign=${campaignId}`, error);
      throw new Error(`IVRスクリプトの完全デプロイに失敗しました: ${error.message}`);
    }
  }

  // 🔧 サポートメソッド1: extensions.confへのinclude追加
  async addIncludeToExtensionsConf(scriptFileName, campaignId) {
    try {
      const extensionsConfPath = '/etc/asterisk/extensions.conf';
      const includeStatement = `#include "/var/www/autodialer/backend/ivr-scripts/${scriptFileName}"`;
      
      logger.info(`🔧 extensions.conf include追加: ${includeStatement}`);
      
      // 現在のextensions.confを読み込み
      let extensionsContent = '';
      try {
        extensionsContent = await fs.readFile(extensionsConfPath, 'utf8');
      } catch (readError) {
        logger.error(`❌ extensions.conf読み込みエラー: ${readError.message}`);
        return false;
      }
      
      // 重複チェック
      if (extensionsContent.includes(scriptFileName)) {
        logger.info(`ℹ️ include文は既に存在します: ${scriptFileName}`);
        return true; // 既に存在するので成功とみなす
      }
      
      // include文を末尾に追加
      const updatedContent = extensionsContent + '\n' + includeStatement + '\n';
      
      // ファイルに書き込み
      await fs.writeFile(extensionsConfPath, updatedContent, 'utf8');
      
      logger.info(`✅ extensions.confにinclude追加完了: campaign-${campaignId}.conf`);
      return true;
      
    } catch (error) {
      logger.error(`❌ extensions.conf include追加エラー:`, error);
      return false;
    }
  }

  // 🔧 サポートメソッド2: Asterisk dialplan reload
  async reloadAsteriskDialplan() {
    try {
      logger.info(`🔄 Asterisk dialplan reload実行中...`);
      
      // Asterisk CLIコマンドでdialplan reload
      const { stdout, stderr } = await execAsync('sudo asterisk -rx "dialplan reload"');
      
      if (stderr && !stderr.includes('Warning')) {
        logger.warn(`⚠️ Asterisk reload警告: ${stderr}`);
      }
      
      if (stdout.includes('Dialplan reloaded') || stdout.includes('done')) {
        logger.info(`✅ Asterisk dialplan reload成功: ${stdout.trim()}`);
        return true;
      } else {
        logger.warn(`⚠️ Asterisk reload結果不明: ${stdout}`);
        return false;
      }
      
    } catch (error) {
      logger.error(`❌ Asterisk dialplan reloadエラー:`, error);
      
      // フォールバック: systemctl reload
      try {
        logger.info(`🔄 フォールバック: systemctl reload asterisk`);
        await execAsync('sudo systemctl reload asterisk');
        logger.info(`✅ systemctl reload完了`);
        return true;
      } catch (systemctlError) {
        logger.error(`❌ systemctl reloadもエラー:`, systemctlError);
        return false;
      }
    }
  }

  // 🔧 サポートメソッド3: IVRコンテキスト検証
  async verifyIvrContext(campaignId) {
    try {
      const contextName = `autodialer-campaign-${campaignId}`;
      logger.info(`🔍 コンテキスト検証中: ${contextName}`);
      
      // Asterisk CLIでコンテキスト存在確認
      const { stdout, stderr } = await execAsync(`sudo asterisk -rx "dialplan show ${contextName}"`);
      
      if (stdout.includes('does not exist') || stdout.includes('No such context')) {
        logger.warn(`⚠️ コンテキストが存在しません: ${contextName}`);
        return false;
      }
      
      if (stdout.includes('Extension') && stdout.includes('Priority')) {
        logger.info(`✅ コンテキスト検証成功: ${contextName}`);
        logger.debug(`コンテキスト内容プレビュー: ${stdout.substring(0, 200)}...`);
        return true;
      }
      
      logger.warn(`⚠️ コンテキスト検証結果不明: ${stdout}`);
      return false;
      
    } catch (error) {
      logger.error(`❌ コンテキスト検証エラー:`, error);
      return false;
    }
  }
}

module.exports = new IvrService();
