// backend/src/services/ivrService.js - 25ç§’å†ç”Ÿåˆ¶é™ç‰ˆ
const logger = require('./logger');
const fs = require('fs').promises;
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');
const execAsync = promisify(exec);
const audioService = require('./audioService');
const db = require('./database');

class IvrService {
  constructor() {
    this.ivrDir = process.env.IVR_SCRIPTS_DIR || path.join(__dirname, '../../ivr-scripts');
    this.initialize();
  }

  async initialize() {
    try {
      // IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèªã€ãªã‘ã‚Œã°ä½œæˆ
      await fs.mkdir(this.ivrDir, { recursive: true });
      logger.info(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ: ${this.ivrDir}`);
    } catch (error) {
      logger.error('IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”¨ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆ25ç§’åˆ¶é™ä»˜ãï¼‰
  async generateIvrScript(campaignId) {
    try {
      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’å–å¾—
      const [campaigns] = await db.query(
        'SELECT c.id, c.name, ci.number as caller_id_number, ci.domain FROM campaigns c JOIN caller_ids ci ON c.caller_id_id = ci.id WHERE c.id = ?',
        [campaignId]
      );
      
      if (campaigns.length === 0) {
        throw new Error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      
      const campaign = campaigns[0];
      
      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      const audioFiles = await audioService.getCampaignAudio(campaignId);
      
      // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ã‚¤ãƒ—ã”ã¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°
      const audioMap = Array.isArray(audioFiles) ? audioFiles.reduce((map, audio) => {
        if (audio && audio.audio_type) {
          map[audio.audio_type] = audio;
        }
        return map;
      }, {}) : {};
      
      // IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†…å®¹ã‚’ç”Ÿæˆ
      let scriptContent = `; IVR Script for Campaign: ${campaign.name} (ID: ${campaignId})\n`;
      scriptContent += `; 25ç§’å†ç”Ÿåˆ¶é™ä»˜ããƒãƒ¼ã‚¸ãƒ§ãƒ³\n\n`;
      
      scriptContent += `[autodialer-campaign-${campaignId}]\n`;
      scriptContent += `exten => s,1,Answer()\n`;
      scriptContent += `  same => n,Wait(1)\n`;
      
      // 25ç§’ã®çµ¶å¯¾ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
      scriptContent += `  same => n,Set(TIMEOUT(absolute)=25)\n`;
      scriptContent += `  same => n,Set(PLAYBACK_START=\${EPOCH})\n`;
      scriptContent += `  same => n,Set(LOOP_COUNT=0)\n`;
      
      // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æ±ºå®šï¼ˆwelcomeã¨menuã‚’çµ±åˆï¼‰
      let audioFile = null;
      if (audioMap.welcome) {
        audioFile = `autodialer/${path.basename(audioMap.welcome.filename, path.extname(audioMap.welcome.filename))}`;
      } else if (audioMap.menu) {
        audioFile = `autodialer/${path.basename(audioMap.menu.filename, path.extname(audioMap.menu.filename))}`;
      } else {
        audioFile = 'vm-tempgreeting';
      }
      
      // åˆ¶é™ä»˜ããƒ«ãƒ¼ãƒ—å†ç”Ÿå‡¦ç†ï¼ˆæœ€å¤§3å›ï¼‰
      // scriptContent += `  same => n(playloop),NoOp(Starting playback loop \${LOOP_COUNT})\n`;
      //scriptContent += `  same => n,Background(${audioFile})\n`;
      //scriptContent += `  same => n,WaitExten(3)\n`;  // 3ç§’é–“DTMFã‚’å¾…ã¤
      //scriptContent += `  same => n,Set(LOOP_COUNT=$[\${LOOP_COUNT} + 1])\n`;
      //scriptContent += `  same => n,GotoIf($[\${LOOP_COUNT} < 3]?playloop)\n`;  // 3å›ã¾ã§
      //scriptContent += `  same => n,Hangup()\n`;  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯åˆ‡æ–­
      
      // === æ–°ã—ã„Read()ç‰ˆï¼ˆç¢ºå®Ÿã«å‹•ä½œï¼‰ ===
ã€€ã€€ã€€scriptContent += `  same => n,Set(ATTEMPTS=0)\n`;
ã€€ã€€ã€€scriptContent += `  same => n(menu),NoOp(=== Playing menu and waiting for DTMF ===)\n`;
ã€€ã€€ã€€scriptContent += `  same => n,System(echo "$(date): Playing menu, DTMF enabled..." >> /tmp/dtmf_debug.log)\n`;
ã€€ã€€ã€€scriptContent += `  same => n,Background(${audioFile})\n`;
ã€€ã€€ã€€scriptContent += `  same => n,WaitExten(5)\n`;
ã€€ã€€ã€€
ã€€ã€€ã€€// ä»¥ä¸‹ã®3è¡Œã‚’è¿½åŠ 
ã€€ã€€ã€€scriptContent += `  same => n,Set(ATTEMPTS=$[\${ATTEMPTS} + 1])\n`;
ã€€ã€€ã€€scriptContent += `  same => n,GotoIf($[\${ATTEMPTS} < 3]?menu)\n`;
ã€€ã€€ã€€scriptContent += `  same => n,Hangup()\n\n`;
ã€€ã€€ã€€// å…¥åŠ›åˆ¤å®š
      //scriptContent += `  same => n,GotoIf($["\${DTMF_INPUT}" = "1"]?pressed_1)\n`;
      //scriptContent += `  same => n,GotoIf($["\${DTMF_INPUT}" = "2"]?pressed_2)\n`;
      //scriptContent += `  same => n,GotoIf($["\${DTMF_INPUT}" = "3"]?pressed_3)\n`;
      //scriptContent += `  same => n,GotoIf($["\${DTMF_INPUT}" = "9"]?pressed_9)\n`;

      // ç„¡åŠ¹ãªå…¥åŠ›ã¾ãŸã¯ç„¡å…¥åŠ›
      //scriptContent += `  same => n,Set(ATTEMPTS=$[\${ATTEMPTS} + 1])\n`;
      //scriptContent += `  same => n,GotoIf($[\${ATTEMPTS} < 3]?menu)\n`;
      //scriptContent += `  same => n,Hangup()\n\n`;

      // ã‚¸ãƒ£ãƒ³ãƒ—ãƒ©ãƒ™ãƒ«
      //scriptContent += `  same => n(pressed_1),Goto(1,1)\n`;
      //scriptContent += `  same => n(pressed_2),Goto(2,1)\n`;
      //scriptContent += `  same => n(pressed_3),Goto(3,1)\n`;
      //scriptContent += `  same => n(pressed_9),Goto(9,1)\n\n`;
      
      // 1ã‚­ãƒ¼: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¥ç¶š
      scriptContent += `exten => 1,1,System(echo "$(date): DTMF 1 pressed - CallID: \${UNIQUEID}" >> /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,NoOp(Operator transfer requested - Key 1)\n`;
      //scriptContent += `  same => n,Set(TIMEOUT(absolute)=)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=1)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`;

      // 2ã‚­ãƒ¼: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¥ç¶š
      scriptContent += `exten => 2,1,System(echo "$(date): DTMF 2 pressed - CallID: \${UNIQUEID}" >> /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,NoOp(Operator transfer requested - Key 2)\n`;
      //scriptContent += `  same => n,Set(TIMEOUT(absolute)=)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=2)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`; 
      
      // 3ã‚­ãƒ¼: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¥ç¶š
      scriptContent += `exten => 3,1,System(echo "$(date): DTMF 3 pressed - CallID: \${UNIQUEID}" >> /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,NoOp(Operator transfer requested - Key 3)\n`;
      //scriptContent += `  same => n,Set(TIMEOUT(absolute)=)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=3)\n`;
      scriptContent += `  same => n,Goto(operator-transfer-${campaignId},s,1)\n\n`;
      
      // 9ã‚­ãƒ¼: é€šè©±çµ‚äº†ï¼ˆDNCãƒªã‚¹ãƒˆã«è¿½åŠ ï¼‰
      scriptContent += `exten => 9,1,System(echo "$(date): DTMF 9 pressed - CallID: \${UNIQUEID}" >> /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,NoOp(DNC requested)\n`;
      //scriptContent += `  same => n,Set(TIMEOUT(absolute)=)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=${campaignId})\n`;
      scriptContent += `  same => n,Set(KEYPRESS=9)\n`;
      scriptContent += `  same => n,Playback(vm-goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ25ç§’çµŒéï¼‰
      scriptContent += `exten => T,1,NoOp(Absolute timeout reached - 25 seconds)\n`;
      scriptContent += `  same => n,Playback(goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // ãã®ä»–ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      scriptContent += `exten => t,1,NoOp(Input timeout occurred)\n`;
      scriptContent += `  same => n,Playback(goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // ç„¡åŠ¹ãªã‚­ãƒ¼å…¥åŠ›
      scriptContent += `exten => i,1,NoOp(Invalid input)\n`;
      scriptContent += `  same => n,Playback(invalid)\n`;
      scriptContent += `  same => n,Goto(s,playloop)\n\n`;
      
      // é€šè©±çµ‚äº†æ™‚ã®å‡¦ç†
      scriptContent += `exten => h,1,NoOp(Hangup handler)\n`;
      scriptContent += `  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=${campaignId}-\${UNIQUEID}&duration=\${ANSWEREDTIME}&disposition=\${DIALSTATUS}&keypress=\${KEYPRESS}")\n`;
      
      // operator-transferã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
      scriptContent += `\n; operator-transfer context\n`;
      scriptContent += `[operator-transfer-${campaignId}]\n`;
      scriptContent += `exten => s,1,NoOp(=== OPERATOR TRANSFER START ===)\n`;
      scriptContent += `  same => n,System(echo "$(date): Transfer Start - CallID: \${UNIQUEID}, Phone: \${CALLERID(num)}, Key: \${KEYPRESS}" >> /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,Set(TRANSFER_CALL_ID=\${UNIQUEID})\n`;
      scriptContent += `  same => n,Set(TRANSFER_CAMPAIGN_ID=\${CAMPAIGN_ID})\n`;
      scriptContent += `  same => n,Set(CONTACT_PHONE=\${CALLERID(num)})\n`;
      scriptContent += `  same => n,NoOp(Variables: CallID=\${TRANSFER_CALL_ID}, Phone=\${CONTACT_PHONE}, Key=\${KEYPRESS})\n`;
      scriptContent += `  same => n,System(curl -X POST http://localhost:5000/api/calls/transfer/dtmf -H "Content-Type: application/json" -d "{\\"callId\\": \\"\${TRANSFER_CALL_ID}\\", \\"originalNumber\\": \\"\${CONTACT_PHONE}\\", \\"keypress\\": \\"\${KEYPRESS}\\", \\"campaignId\\": \\"\${TRANSFER_CAMPAIGN_ID}\\"}" 2>&1 | tee -a /tmp/dtmf_debug.log)\n`;
      scriptContent += `  same => n,Wait(2)\n`;
      scriptContent += `  same => n,Playback(one-moment-please)\n`;
      scriptContent += `  same => n,Hangup()\n\n`; 
      
scriptContent += `exten => s,1,NoOp(=== OPERATOR TRANSFER START ===)\n`;
scriptContent += `  same => n,System(echo "$(date): Transfer Start - CallID: \${UNIQUEID}, Phone: \${CALLERID(num)}, Key: \${KEYPRESS}" >> /tmp/dtmf_debug.log)\n`;
scriptContent += `  same => n,Set(TRANSFER_CALL_ID=\${UNIQUEID})\n`;
scriptContent += `  same => n,Set(TRANSFER_CAMPAIGN_ID=\${CAMPAIGN_ID})\n`;
scriptContent += `  same => n,Set(CONTACT_PHONE=\${CALLERID(num)})\n`;
scriptContent += `  same => n,NoOp(Variables: CallID=\${TRANSFER_CALL_ID}, Phone=\${CONTACT_PHONE}, Key=\${KEYPRESS})\n`;
scriptContent += `  same => n,System(curl -s -X POST http://localhost:5000/api/calls/transfer/dtmf -H "Content-Type: application/json" -d "{\\"callId\\": \\"\${TRANSFER_CALL_ID}\\", \\"originalNumber\\": \\"\${CONTACT_PHONE}\\", \\"keypress\\": \\"\${KEYPRESS}\\", \\"campaignId\\": \\"\${TRANSFER_CAMPAIGN_ID}\\"}" 2>&1 | tee -a /tmp/dtmf_debug.log)\n`;
scriptContent += `  same => n,Wait(1)\n`;
scriptContent += `  same => n,Playback(pls-wait-connect-call)\n`;

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è»¢é€å…ˆè¨­å®š
scriptContent += `  same => n,GotoIf($["\\${KEYPRESS}" = "1"]?transfer1)\n`;
scriptContent += `  same => n,GotoIf($["\\${KEYPRESS}" = "2"]?transfer2)\n`;
scriptContent += `  same => n,GotoIf($["\\${KEYPRESS}" = "3"]?transfer3)\n`;
scriptContent += `  same => n,Hangup()\n`;
scriptContent += `  same => n(transfer1),NoOp(Transferring to 03500001)\n`;
scriptContent += `  same => n,Dial(PJSIP/03500001,30,tT)\n`;
scriptContent += `  same => n,Hangup()\n`;
scriptContent += `  same => n(transfer2),NoOp(Transferring to 03500002)\n`;
scriptContent += `  same => n,Dial(PJSIP/03500002,30,tT)\n`;
scriptContent += `  same => n,Hangup()\n`;
scriptContent += `  same => n(transfer3),NoOp(Transferring to 03500003)\n`;
scriptContent += `  same => n,Dial(PJSIP/03500003,30,tT)\n`;
scriptContent += `  same => n,Hangup()\n\n`; 
      // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
      const scriptPath = path.join(this.ivrDir, `campaign-${campaignId}.conf`);
      await fs.writeFile(scriptPath, scriptContent);
      
      logger.info(`25ç§’åˆ¶é™ä»˜ãã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${scriptPath}`);
      
      return {
        path: scriptPath,
        content: scriptContent
      };
    } catch (error) {
      logger.error(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: Campaign=${campaignId}`, error);
      throw error;
    }
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç™ºä¿¡ç”¨ï¼‰
  async generateDefaultIvrScript() {
    try {
      let scriptContent = `; Default IVR Script for Test Calls\n\n`;
      
      scriptContent += `[autodialer-test]\n`;
      scriptContent += `exten => s,1,Answer()\n`;
      scriptContent += `  same => n,Wait(1)\n`;
      scriptContent += `  same => n,Playback(vm-greeting)\n`;
      scriptContent += `  same => n,Playback(vm-tempgreeting)\n`;
      scriptContent += `  same => n,WaitExten(10)\n\n`;
      
      // 1ã‚­ãƒ¼: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æ¥ç¶š
      scriptContent += `exten => 1,1,NoOp(Operator transfer requested)\n`;
      scriptContent += `  same => n,Set(CAMPAIGN_ID=test)\n`;
      scriptContent += `  same => n,Set(KEYPRESS=1)\n`;
      scriptContent += `  same => n,Playback(one-moment-please)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // 9ã‚­ãƒ¼: é€šè©±çµ‚äº†ï¼ˆDNCãƒªã‚¹ãƒˆã«è¿½åŠ ï¼‰
      scriptContent += `exten => 9,1,NoOp(DNC requested)\n`;
      scriptContent += `  same => n,Set(KEYPRESS=9)\n`;
      scriptContent += `  same => n,Playback(vm-goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ãã®ä»–ã®ã‚­ãƒ¼å…¥åŠ›
      scriptContent += `exten => t,1,NoOp(Timeout occurred)\n`;
      scriptContent += `  same => n,Playback(goodbye)\n`;
      scriptContent += `  same => n,Hangup()\n\n`;
      
      // ç„¡åŠ¹ãªã‚­ãƒ¼å…¥åŠ›
      scriptContent += `exten => i,1,NoOp(Invalid input)\n`;
      scriptContent += `  same => n,Playback(invalid)\n`;
      scriptContent += `  same => n,Goto(s,4)\n\n`;
      
      // é€šè©±çµ‚äº†æ™‚ã®å‡¦ç†
      scriptContent += `exten => h,1,NoOp(Hangup handler)\n`;
      scriptContent += `  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=test-\${UNIQUEID}&duration=\${ANSWEREDTIME}&disposition=\${DIALSTATUS}&keypress=\${KEYPRESS}")\n`;
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
      const scriptPath = path.join(this.ivrDir, 'default-test.conf');
      await fs.writeFile(scriptPath, scriptContent);
      
      logger.info(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${scriptPath}`);
      
      return {
        path: scriptPath,
        content: scriptContent
      };
    } catch (error) {
      logger.error('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIVRã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  // IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
  async saveIvrScript(campaignId, script) {
    try {
      if (!script) {
        logger.warn(`ç©ºã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹ã§ã™: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID ${campaignId}`);
        return false;
      }
      
      const scriptPath = path.join(this.ivrDir, `campaign-${campaignId}.conf`);
      await fs.writeFile(scriptPath, script);
      
      logger.info(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${scriptPath}`);
      
      return {
        path: scriptPath,
        success: true
      };
    } catch (error) {
      logger.error(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      throw error;
    }
  }

  async deployIvrScripts() {
    try {
      logger.info('å…¨ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­...');
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’å–å¾—
      const [campaigns] = await db.query(`
        SELECT id, name FROM campaigns 
        WHERE status IN ('active', 'paused') 
        ORDER BY id
      `);
      
      if (campaigns.length === 0) {
        logger.info('ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
        return true;
      }
      
      let successCount = 0;
      let errorCount = 0;
      
      // å„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      for (const campaign of campaigns) {
        try {
          await this.deployIvrScript(campaign.id);
          successCount++;
          logger.info(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaign.id} (${campaign.name}) ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ`);
        } catch (error) {
          errorCount++;
          logger.error(`ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaign.id} (${campaign.name}) ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—:`, error.message);
        }
      }
      
      logger.info(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: æˆåŠŸ=${successCount}, å¤±æ•—=${errorCount}`);
      return true;
    } catch (error) {
      logger.error('IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  }

  // ğŸš€ å®Œå…¨å®Ÿè£…ç‰ˆ: å€‹åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”¨ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ100%å®Œæˆï¼‰
  async deployIvrScript(campaignId) {
    try {
      logger.info(`ğŸš€ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaignId} ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹...`);
      
      // Step 1: IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
      logger.info(`ğŸ“ Step 1: IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆä¸­...`);
      const scriptResult = await this.generateIvrScript(campaignId);
      
      if (!scriptResult || !scriptResult.path) {
        throw new Error('IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const scriptPath = scriptResult.path;
      const scriptFileName = path.basename(scriptPath);
      
      logger.info(`âœ… IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆå®Œäº†: ${scriptPath}`);
      
      // Step 2: extensions.confã¸ã®includeè¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
      logger.info(`ğŸ“ Step 2: extensions.confã¸ã®includeè¿½åŠ ä¸­...`);
// //       const includeAdded = await this.addIncludeToExtensionsConf(scriptFileName, campaignId);
      
//       if (!includeAdded) {
//         logger.info(`â„¹ï¸ includeè¿½åŠ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜ã¾ãŸã¯ä¸è¦ï¼‰`);
//       }
      
      // Step 3: Asterisk dialplan reload
      logger.info(`ğŸ“ Step 3: Asterisk dialplan reloadå®Ÿè¡Œä¸­...`);
      const reloadSuccess = await this.reloadAsteriskDialplan();
      
      if (!reloadSuccess) {
        logger.warn('âš ï¸ Asterisk dialplan reloadã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™');
      }
      
      // Step 4: ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
      logger.info(`ğŸ“ Step 4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜éŒ²ä¸­...`);
      try {
        await db.query(
          'UPDATE campaigns SET ivr_deployed = true, ivr_deploy_time = NOW() WHERE id = ?',
          [campaignId]
        );
        logger.info(`âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜éŒ²å®Œäº†`);
      } catch (dbError) {
        logger.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜éŒ²ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ã¯ç¶šè¡Œï¼‰:', dbError.message);
      }
      
      // Step 5: ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼
      logger.info(`ğŸ“ Step 5: ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ä¸­...`);
      const contextExists = await this.verifyIvrContext(campaignId);
      
      if (contextExists) {
        logger.info(`âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaignId} ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼`);
        logger.info(`ğŸ¯ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ "autodialer-campaign-${campaignId}" ãŒAsteriskã«æ­£å¸¸ç™»éŒ²ã•ã‚Œã¾ã—ãŸ`);
      } else {
        logger.warn(`âš ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼å¤±æ•— - æ‰‹å‹•ç¢ºèªãŒå¿…è¦ã§ã™`);
      }
      
      return {
        success: true,
        scriptPath: scriptPath,
        contextName: `autodialer-campaign-${campaignId}`,
        includeAdded: true, // includeAdded,
        reloadSuccess: reloadSuccess,
        verified: contextExists,
        message: `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaignId} ã®IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ`
      };
      
    } catch (error) {
      logger.error(`âŒ IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼: Campaign=${campaignId}`, error);
      throw new Error(`IVRã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
  }

  // ğŸ”§ ã‚µãƒãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰1: extensions.confã¸ã®includeè¿½åŠ 
  async addIncludeToExtensionsConf(scriptFileName, campaignId) {
    try {
      const extensionsConfPath = '/etc/asterisk/extensions.conf';
      const includeStatement = `#include "/var/www/autodialer/backend/ivr-scripts/${scriptFileName}"`;
      
      logger.info(`ğŸ”§ extensions.conf includeè¿½åŠ : ${includeStatement}`);
      
      // ç¾åœ¨ã®extensions.confã‚’èª­ã¿è¾¼ã¿
      let extensionsContent = '';
      try {
        extensionsContent = await fs.readFile(extensionsConfPath, 'utf8');
      } catch (readError) {
        logger.error(`âŒ extensions.confèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${readError.message}`);
        return false;
      }
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (extensionsContent.includes(scriptFileName)) {
        logger.info(`â„¹ï¸ includeæ–‡ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™: ${scriptFileName}`);
        return true; // æ—¢ã«å­˜åœ¨ã™ã‚‹ã®ã§æˆåŠŸã¨ã¿ãªã™
      }
      
      // includeæ–‡ã‚’æœ«å°¾ã«è¿½åŠ 
      const updatedContent = extensionsContent + '\n' + includeStatement + '\n';
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
      await fs.writeFile(extensionsConfPath, updatedContent, 'utf8');
      
      logger.info(`âœ… extensions.confã«includeè¿½åŠ å®Œäº†: campaign-${campaignId}.conf`);
      return true;
      
    } catch (error) {
      logger.error(`âŒ extensions.conf includeè¿½åŠ ã‚¨ãƒ©ãƒ¼:`, error);
      return false;
    }
  }

  // ğŸ”§ ã‚µãƒãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰2: Asterisk dialplan reload
  async reloadAsteriskDialplan() {
    try {
      logger.info(`ğŸ”„ Asterisk dialplan reloadå®Ÿè¡Œä¸­...`);
      
      // Asterisk CLIã‚³ãƒãƒ³ãƒ‰ã§dialplan reload
      const { stdout, stderr } = await execAsync('sudo asterisk -rx "dialplan reload"');
      
      if (stderr && !stderr.includes('Warning')) {
        logger.warn(`âš ï¸ Asterisk reloadè­¦å‘Š: ${stderr}`);
      }
      
      if (stdout.includes('Dialplan reloaded') || stdout.includes('done')) {
        logger.info(`âœ… Asterisk dialplan reloadæˆåŠŸ: ${stdout.trim()}`);
        return true;
      } else {
        logger.warn(`âš ï¸ Asterisk reloadçµæœä¸æ˜: ${stdout}`);
        return false;
      }
      
    } catch (error) {
      logger.error(`âŒ Asterisk dialplan reloadã‚¨ãƒ©ãƒ¼:`, error);
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: systemctl reload
      try {
        logger.info(`ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: systemctl reload asterisk`);
        await execAsync('sudo systemctl reload asterisk');
        logger.info(`âœ… systemctl reloadå®Œäº†`);
        return true;
      } catch (systemctlError) {
        logger.error(`âŒ systemctl reloadã‚‚ã‚¨ãƒ©ãƒ¼:`, systemctlError);
        return false;
      }
    }
  }

  // ğŸ”§ ã‚µãƒãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰3: IVRã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼
  async verifyIvrContext(campaignId) {
    try {
      const contextName = `autodialer-campaign-${campaignId}`;
      logger.info(`ğŸ” ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼ä¸­: ${contextName}`);
      
      // Asterisk CLIã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå­˜åœ¨ç¢ºèª
      const { stdout, stderr } = await execAsync(`sudo asterisk -rx "dialplan show ${contextName}"`);
      
      if (stdout.includes('does not exist') || stdout.includes('No such context')) {
        logger.warn(`âš ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${contextName}`);
        return false;
      }
      
      if (stdout.includes('Extension') && stdout.includes('Priority')) {
        logger.info(`âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼æˆåŠŸ: ${contextName}`);
        logger.debug(`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${stdout.substring(0, 200)}...`);
        return true;
      }
      
      logger.warn(`âš ï¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼çµæœä¸æ˜: ${stdout}`);
      return false;
      
    } catch (error) {
      logger.error(`âŒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼ã‚¨ãƒ©ãƒ¼:`, error);
      return false;
    }
  }
}

module.exports = new IvrService();
