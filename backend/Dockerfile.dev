FROM node:18-alpine

WORKDIR /app

# 必要なパッケージと開発ツールをインストール
RUN apk update && apk add --no-cache \
    build-base \
    git \
    make \
    gcc \
    g++ \
    linux-headers \
    # PJSIPをインストール
    pjproject \
    pjproject-dev

# パッケージインストール用ファイルのみコピー
COPY package*.json ./

# 通常のnpm installを使用して依存関係をインストール
RUN npm install

# nodemonをグローバルにインストール
RUN npm install -g nodemon

# pjsuaコマンドのラッパースクリプトを作成して、sipcmdの代わりに使用
RUN echo '#!/bin/sh' > /usr/local/bin/sipcmd && \
    echo 'pjsua \
      --id="sip:$1@$4" \
      --registrar="sip:$4" \
      --realm="*" \
      --username="$1" \
      --password="$2" \
      --null-audio \
      --no-vad \
      --duration=$7 \
      sip:$5@$4' >> /usr/local/bin/sipcmd && \
    chmod +x /usr/local/bin/sipcmd

# アプリケーションのポートを公開
EXPOSE 5000

# 開発モードで起動
CMD ["nodemon", "src/index.js"]