FROM node:18-alpine

WORKDIR /app

# 必要なパッケージと開発ツールをインストール
RUN apk update && apk add --no-cache \
    build-base \
    git \
    make \
    gcc \
    g++ \
    linux-headers

# パッケージインストール用ファイルのみコピー
COPY package*.json ./

# 通常のnpm installを使用して依存関係をインストール
RUN npm install

# nodemonをグローバルにインストール
RUN npm install -g nodemon

# ダミーのsipcmdスクリプトを作成 (sipcmdビルドが難しい場合の代替策)
RUN echo '#!/bin/sh' > /usr/local/bin/sipcmd && \
    echo 'echo "SIP call simulation started: $@"' >> /usr/local/bin/sipcmd && \
    echo 'sleep 2' >> /usr/local/bin/sipcmd && \
    echo 'echo "Call established"' >> /usr/local/bin/sipcmd && \
    echo 'sleep 5' >> /usr/local/bin/sipcmd && \
    echo 'echo "Call completed"' >> /usr/local/bin/sipcmd && \
    echo 'exit 0' >> /usr/local/bin/sipcmd && \
    chmod +x /usr/local/bin/sipcmd

# アプリケーションのポートを公開
EXPOSE 5000

# 開発モードで起動
CMD ["nodemon", "src/index.js"]