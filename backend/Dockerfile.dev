FROM node:18-alpine

WORKDIR /app

# 必要なパッケージと開発ツールをインストール（問題のパッケージを削除）
RUN apk update && apk add --no-cache \
    alsa-lib \
    alsa-utils \
    build-base \
    git \
    make \
    gcc \
    g++ \
    linux-headers \
    # PJSIPをインストール
    pjsua \
    pjproject \
    iputils \
    netcat-openbsd \
    tcpdump \
    socat

# パッケージインストール用ファイルのみコピー
COPY package*.json ./

# 依存関係をインストール
RUN npm install

# nodemonをグローバルにインストール
RUN npm install -g nodemon

# pjsuaコマンドのラッパースクリプトを作成して、sipcmdの代わりに使用
RUN echo '#!/bin/sh' > /usr/local/bin/sipcmd && \
    echo 'echo "Executing SIP call: $1@$3 -> $4"' >> /usr/local/bin/sipcmd && \
    echo 'pjsua \
      --id="sip:$1@$3" \
      --registrar="sip:$3" \
      --realm="*" \
      --username="$1" \
      --password="$2" \
      --null-audio \
      --no-vad \
      --auto-play \
      --duration=30 \
      --log-level=5 \
      sip:$4@$3' >> /usr/local/bin/sipcmd && \
    chmod +x /usr/local/bin/sipcmd

# デバッグ用の簡易シェルスクリプトを作成
RUN echo '#!/bin/sh' > /usr/local/bin/test-sip && \
    echo 'echo "Testing SIP connection to $1 with account $2..."' >> /usr/local/bin/test-sip && \
    echo 'pjsua \
      --id="sip:$2@ito258258.site" \
      --registrar="sip:ito258258.site" \
      --realm="*" \
      --username="$2" \
      --password="$3" \
      --null-audio \
      --no-vad \
      --auto-play \
      --duration=30 \
      --log-level=5 \
      sip:$1@ito258258.site' >> /usr/local/bin/test-sip && \
    chmod +x /usr/local/bin/test-sip

# アプリケーションのポートを公開
EXPOSE 5000

# 開発モードで起動
CMD ["nodemon", "src/index.js"]