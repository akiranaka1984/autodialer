; IVR Script for Campaign: AAA (ID: 209)
; 25秒再生制限付きバージョン

[autodialer-campaign-209]
exten => s,1,Answer()
  same => n,Wait(1)
  same => n,Set(TIMEOUT(absolute)=25)
  same => n,Set(PLAYBACK_START=${EPOCH})
  same => n,Set(LOOP_COUNT=0)
  same => n(playloop),NoOp(Starting playback loop)
  same => n,Set(CURRENT_TIME=${EPOCH})
  same => n,Set(ELAPSED_TIME=${MATH(${CURRENT_TIME}-${PLAYBACK_START},int)})
  same => n,GotoIf($[${ELAPSED_TIME} >= 23]?waitforkey)
  same => n,Background(autodialer/61ab278c-312d-4f65-8632-fec3beca0b41-549444996463302)
  same => n,Set(LOOP_COUNT=$[${LOOP_COUNT} + 1])
  same => n,NoOp(Loop count: ${LOOP_COUNT}, Elapsed: ${ELAPSED_TIME} seconds)
  same => n,Goto(playloop)
  same => n(waitforkey),NoOp(25 seconds elapsed, waiting for key input)
  same => n,WaitExten(2)

exten => 1,1,NoOp(Operator transfer requested - Key 1)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=209)
  same => n,Set(KEYPRESS=1)
  same => n,Goto(operator-transfer-209,s,1)

exten => 2,1,NoOp(Operator transfer requested - Key 2)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=209)
  same => n,Set(KEYPRESS=2)
  same => n,Goto(operator-transfer-209,s,1)

exten => 3,1,NoOp(Operator transfer requested - Key 3)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=209)
  same => n,Set(KEYPRESS=3)
  same => n,Goto(operator-transfer-209,s,1)

exten => 9,1,NoOp(DNC requested)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=209)
  same => n,Set(KEYPRESS=9)
  same => n,Playback(vm-goodbye)
  same => n,Hangup()

exten => T,1,NoOp(Absolute timeout reached - 25 seconds)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => t,1,NoOp(Input timeout occurred)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => i,1,NoOp(Invalid input)
  same => n,Playback(invalid)
  same => n,Goto(s,playloop)

exten => h,1,NoOp(Hangup handler)
  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=209-${UNIQUEID}&duration=${ANSWEREDTIME}&disposition=${DIALSTATUS}&keypress=${KEYPRESS}")

; operator-transfer context
[operator-transfer-209]
exten => s,1,NoOp(=== OPERATOR TRANSFER ===)
  same => n,Set(TRANSFER_CALL_ID=${UNIQUEID})
  same => n,Set(TRANSFER_CAMPAIGN_ID=${CAMPAIGN_ID})
  same => n,Set(CONTACT_PHONE=${CALLERID(num)})
  same => n,System(/usr/local/bin/transfer_notify.sh "${TRANSFER_CALL_ID}" "${TRANSFER_CAMPAIGN_ID}" "${KEYPRESS}" "${CONTACT_PHONE}")
  same => n,Wait(0.5)
  same => n,Set(TRANSFER_DEST=${SHELL(cat /tmp/transfer_${TRANSFER_CALL_ID}.txt 2>/dev/null | tr -d '\n')})
  same => n,GotoIf($[${LEN(${TRANSFER_DEST})} = 0]?transfer-failed)
  same => n,NoOp(Transfer to: ${TRANSFER_DEST})
  same => n,Playback(pls-wait-connect-call)
  same => n,Transfer(PJSIP/${TRANSFER_DEST}@pantex.online)
  same => n(transfer-failed),NoOp(Transfer failed)
  same => n,Playback(beeperr)
  same => n,Hangup()
  same => n,System(rm -f /tmp/transfer_${TRANSFER_CALL_ID}.txt)
