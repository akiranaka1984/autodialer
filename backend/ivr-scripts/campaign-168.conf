; IVR Script for Campaign: テスト62 (ID: 168)
; 25秒再生制限付きバージョン

[autodialer-campaign-168]
exten => s,1,Answer()
  same => n,Wait(1)
  same => n,Set(TIMEOUT(absolute)=25)
  same => n,Set(TIMEOUT(response)=5)
  same => n,Set(TIMEOUT(digit)=3)
  same => n,Set(PLAYBACK_START=${EPOCH})
  same => n,Set(LOOP_COUNT=0)
  same => n,Set(ATTEMPTS=0)
  same => n(menu),NoOp(=== IVR menu (Read-based with prompt) ===)
  same => n,System(echo "$(date): Read with prompt start..." >> /tmp/dtmf_debug.log)
  same => n,Read(PRESSED_KEY,autodialer/f767ac02-8b99-4bfa-bcd9-37646d67f746-549444996463302,1,,5,1)
  same => n,System(echo "[$(date '+%F %T')] Read => \${PRESSED_KEY} (status=\${READSTATUS})" >> /tmp/dtmf_debug.log)
  same => n,GotoIf($["\${READSTATUS}"="TIMEOUT"]?retry)
  same => n,GotoIf($["\${PRESSED_KEY}"="1" | "\${PRESSED_KEY}"="2" | "\${PRESSED_KEY}"="3" | "\${PRESSED_KEY}"="9"]?route)
  same => n,Playback(invalid)
  same => n(retry),Set(ATTEMPTS=$[\${ATTEMPTS} + 1])
  same => n,GotoIf($[\${ATTEMPTS} < 3]?menu)
  same => n,Playback(goodbye)
  same => n,Hangup()
  same => n(route),GotoIf($["\${PRESSED_KEY}"="9"]?hangup9)
  same => n,Set(KEYPRESS=\${PRESSED_KEY})
  same => n,Set(CAMPAIGN_ID=168)
  same => n,NoOp(Operator transfer requested - Key \${KEYPRESS})
  same => n,Set(TIMEOUT(absolute)=0)
  same => n,Goto(operator-transfer-168,s,1)
  same => n(hangup9),System(echo "$(date): DTMF 9 pressed - CallID: \${ORIG_CALL_ID}" >> /tmp/dtmf_debug.log)
  same => n,Playback(vm-goodbye)
  same => n,Hangup()

exten => T,1,NoOp(Absolute timeout reached - 25 seconds)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => t,1,NoOp(Input timeout occurred)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => i,1,NoOp(Invalid input)
  same => n,Playback(invalid)
  same => n,Goto(s,menu)

exten => h,1,NoOp(Hangup handler)
  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=168-\${ORIG_CALL_ID}&duration=\${ANSWEREDTIME}&disposition=\${DIALSTATUS}")

; operator-transfer context
[operator-transfer-168]
exten => s,1,NoOp(=== OPERATOR TRANSFER START ===)
  same => n,Set(TIMEOUT(absolute)=0)
  same => n,System(echo "[$(date)] Transfer Start - CallID: \${ORIG_CALL_ID}, Phone: \${CALLERID(num)}, Key: \${KEYPRESS}" >> /tmp/dtmf_debug.log)
  same => n,Set(TRANSFER_CALL_ID=\${ORIG_CALL_ID})
  same => n,Set(TRANSFER_CAMPAIGN_ID=\${CAMPAIGN_ID})
  same => n,Set(CONTACT_PHONE=\${CALLERID(num)})
  same => n,NoOp(Variables: CallID=\${TRANSFER_CALL_ID}, Phone=\${CONTACT_PHONE}, Key=\${KEYPRESS})
  same => n,Playback(pls-wait-connect-call)
  same => n,Wait(1)
  same => n,GotoIf($["\${KEYPRESS}" = "1"]?transfer1)
  same => n,GotoIf($["\${KEYPRESS}" = "2"]?transfer2)
  same => n,GotoIf($["\${KEYPRESS}" = "3"]?transfer3)
  same => n,Playback(sorry)
  same => n,Hangup()
  same => n(transfer1),NoOp(=== Transferring to 02160020 for key 1 ===)
  same => n,System(echo "[$(date)] Dialing 02160020" >> /tmp/dtmf_debug.log)
  same => n,Set(TRANSFER_TARGET=02160020)
  same => n,Dial(PJSIP/02160020,30,tT)
  same => n,NoOp(Dial Status: \${DIALSTATUS})
  same => n,System(echo "[$(date)] Dial Status: \${DIALSTATUS} for 02160020" >> /tmp/dtmf_debug.log)
  same => n,GotoIf($["\${DIALSTATUS}" = "ANSWER"]?success1)
  same => n,Playback(sorry)
  same => n,Hangup()
  same => n(success1),NoOp(Transfer Successful to 02160020)
  same => n,Hangup()
  same => n(transfer2),NoOp(=== Transferring to 02160019 for key 2 ===)
  same => n,System(echo "[$(date)] Dialing 02160019" >> /tmp/dtmf_debug.log)
  same => n,Set(TRANSFER_TARGET=02160019)
  same => n,Dial(PJSIP/02160019,30,tT)
  same => n,NoOp(Dial Status: \${DIALSTATUS})
  same => n,System(echo "[$(date)] Dial Status: \${DIALSTATUS} for 02160019" >> /tmp/dtmf_debug.log)
  same => n,GotoIf($["\${DIALSTATUS}" = "ANSWER"]?success2)
  same => n,Playback(sorry)
  same => n,Hangup()
  same => n(success2),NoOp(Transfer Successful to 02160019)
  same => n,Hangup()
  same => n(transfer3),NoOp(=== Transferring to 02160018 for key 3 ===)
  same => n,System(echo "[$(date)] Dialing 02160018" >> /tmp/dtmf_debug.log)
  same => n,Set(TRANSFER_TARGET=02160018)
  same => n,Dial(PJSIP/02160018,30,tT)
  same => n,NoOp(Dial Status: \${DIALSTATUS})
  same => n,System(echo "[$(date)] Dial Status: \${DIALSTATUS} for 02160018" >> /tmp/dtmf_debug.log)
  same => n,GotoIf($["\${DIALSTATUS}" = "ANSWER"]?success3)
  same => n,Playback(sorry)
  same => n,Hangup()
  same => n(success3),NoOp(Transfer Successful to 02160018)
  same => n,Hangup()

