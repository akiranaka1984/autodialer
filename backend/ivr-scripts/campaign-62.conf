; IVR Script for Campaign: テスト (ID: 62)
; 25秒再生制限付きバージョン

[autodialer-campaign-62]
exten => s,1,Answer()
  same => n,Wait(1)
  same => n,Set(TIMEOUT(absolute)=25)
  same => n,Set(PLAYBACK_START=${EPOCH})
  same => n,Set(LOOP_COUNT=0)
  same => n,Set(ATTEMPTS=0)
  same => n(menu),NoOp(=== Playing menu and waiting for DTMF ===)
  same => n,System(echo "$(date): Playing menu, DTMF enabled..." >> /tmp/dtmf_debug.log)
  same => n,Background(autodialer/f767ac02-8b99-4bfa-bcd9-37646d67f746-549444996463302)
  same => n,WaitExten(5)
  same => n,Set(ATTEMPTS=$[${ATTEMPTS} + 1])
  same => n,GotoIf($[${ATTEMPTS} < 3]?menu)
  same => n,Hangup()

exten => 1,1,System(echo "$(date): DTMF 1 pressed - CallID: ${ORIG_CALL_ID}" >> /tmp/dtmf_debug.log)
  same => n,NoOp(Operator transfer requested - Key 1)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=62)
  same => n,Set(KEYPRESS=1)
  same => n,Goto(operator-transfer-62,s,1)

exten => 2,1,System(echo "$(date): DTMF 2 pressed - CallID: ${ORIG_CALL_ID}" >> /tmp/dtmf_debug.log)
  same => n,NoOp(Operator transfer requested - Key 2)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=62)
  same => n,Set(KEYPRESS=2)
  same => n,Goto(operator-transfer-62,s,1)

exten => 3,1,System(echo "$(date): DTMF 3 pressed - CallID: ${ORIG_CALL_ID}" >> /tmp/dtmf_debug.log)
  same => n,NoOp(Operator transfer requested - Key 3)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=62)
  same => n,Set(KEYPRESS=3)
  same => n,Goto(operator-transfer-62,s,1)

exten => 9,1,System(echo "$(date): DTMF 9 pressed - CallID: ${ORIG_CALL_ID}" >> /tmp/dtmf_debug.log)
  same => n,NoOp(DNC requested)
  same => n,Set(TIMEOUT(absolute)=)
  same => n,Set(CAMPAIGN_ID=62)
  same => n,Set(KEYPRESS=9)
  same => n,Playback(vm-goodbye)
  same => n,Hangup()

exten => T,1,NoOp(Absolute timeout reached - 25 seconds)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => t,1,NoOp(Input timeout occurred)
  same => n,Playback(goodbye)
  same => n,Hangup()

exten => i,1,NoOp(Invalid input)
  same => n,Playback(invalid)
  same => n,Goto(s,playloop)

exten => h,1,NoOp(Hangup handler)
  same => n,System(curl -X POST http://localhost:5000/api/callback/call-end -d "callId=62-${ORIG_CALL_ID}&duration=${ANSWEREDTIME}&disposition=${DIALSTATUS}&keypress=${KEYPRESS}")

; operator-transfer context
[operator-transfer-62]
exten => s,1,NoOp(=== OPERATOR TRANSFER START ===)
  same => n,System(echo "$(date): Transfer Start - CallID: ${ORIG_CALL_ID}, Phone: ${CALLERID(num)}, Key: ${KEYPRESS}" >> /tmp/dtmf_debug.log)
  same => n,Set(TRANSFER_CALL_ID=${ORIG_CALL_ID})
  same => n,Set(TRANSFER_CAMPAIGN_ID=${CAMPAIGN_ID})
  same => n,Set(CONTACT_PHONE=${CALLERID(num)})
  same => n,NoOp(Variables: CallID=${TRANSFER_CALL_ID}, Phone=${CONTACT_PHONE}, Key=${KEYPRESS})
  same => n,System(curl -X POST http://localhost:5000/api/calls/transfer/dtmf -H "Content-Type: application/json" -d "{\"callId\": \"${TRANSFER_CALL_ID}\", \"originalNumber\": \"${CONTACT_PHONE}\", \"keypress\": \"${KEYPRESS}\", \"campaignId\": \"${TRANSFER_CAMPAIGN_ID}\"}" 2>&1 | tee -a /tmp/dtmf_debug.log)
  same => n,Wait(2)
  same => n,Playback(one-moment-please)
  same => n,Hangup()

